---
/**
 * Matrix Rain - Digital rain effect with 3D depth
 */
import ModernButton from './ModernButton.astro';
---

<div class="matrix-wrapper" data-density="normal" data-glow="true">
  <h2 class="matrix-title">Digital Matrix Rain</h2>
  <p class="matrix-subtitle">Cascading code with depth perspective</p>

  <div class="matrix-status" aria-live="polite">
    <span class="status-label">Density</span>
    <span class="status-value" data-matrix-status>Normal</span>
    <span class="status-divider" aria-hidden="true"></span>
    <span class="status-label">Glow</span>
    <span class="status-value" data-matrix-glow>On</span>
  </div>

  <div class="matrix-hud" aria-hidden="true">
    <span class="hud-chip">Signal 94%</span>
    <span class="hud-chip">Stream sync</span>
    <span class="hud-chip">Auto focus</span>
  </div>

  <div
    class="matrix-controls"
    role="group"
    aria-label="Matrix density controls"
  >
    <ModernButton
      variant="neon"
      className="matrix-btn"
      data-density="low"
      aria-pressed="false"
      aria-label="Low density">Low</ModernButton
    >
    <ModernButton
      variant="neon"
      className="matrix-btn active"
      data-density="normal"
      aria-pressed="true"
      aria-label="Normal density">Normal</ModernButton
    >
    <ModernButton
      variant="neon"
      className="matrix-btn"
      data-density="high"
      aria-pressed="false"
      aria-label="High density">High</ModernButton
    >
    <ModernButton
      variant="neon"
      className="matrix-btn active"
      data-matrix-toggle="glow"
      aria-pressed="true"
      aria-label="Toggle glow">Glow</ModernButton
    >
  </div>

  <div class="matrix-container">
    <div class="matrix-overlay" aria-hidden="true"></div>
    <div class="matrix-scanlines" aria-hidden="true"></div>
    <div class="matrix-scene">
      {
        Array.from({ length: 30 }).map((_, i) => {
          const characters =
            'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
          const columnHeight = 15 + Math.floor(Math.random() * 20);
          return (
            <div
              class="matrix-column"
              style={`
              --column-index: ${i};
              --column-delay: ${i * 0.2}s;
              --column-speed: ${3 + Math.random() * 4}s;
              --column-depth: ${Math.random() * 200 - 100}px;
            `}
            >
              {Array.from({ length: columnHeight }).map(() => {
                const char =
                  characters[Math.floor(Math.random() * characters.length)];
                const charDelay = Math.random().toFixed(3);
                return (
                  <div
                    class="matrix-char"
                    style={`--char-delay: ${charDelay}s;`}
                  >
                    {char}
                  </div>
                );
              })}
            </div>
          );
        })
      }

      <!-- Glowing core -->
      <div class="matrix-core"></div>
    </div>
  </div>
</div>

<style>
  .matrix-wrapper {
    content-visibility: auto;
    contain: layout paint style;
    contain-intrinsic-size: 800px;
    padding: 8rem 2rem;
    background: radial-gradient(
      ellipse at center,
      rgba(34, 197, 94, 0.1),
      #000
    );
    min-height: 800px;
    position: relative;
    overflow: hidden;
  }

  .matrix-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      linear-gradient(
        0deg,
        transparent 0%,
        rgba(34, 197, 94, 0.05) 50%,
        transparent 100%
      ),
      linear-gradient(
        90deg,
        transparent 0%,
        rgba(34, 197, 94, 0.05) 50%,
        transparent 100%
      );
    background-size:
      100% 50px,
      50px 100%;
    animation: gridScroll 20s linear infinite;
  }

  @keyframes gridScroll {
    0% {
      background-position:
        0 0,
        0 0;
    }
    100% {
      background-position:
        0 50px,
        50px 0;
    }
  }

  .matrix-title {
    font-size: 4rem;
    font-weight: 900;
    text-align: center;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #22c55e 0%, #10b981 50%, #14b8a6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
    position: relative;
    z-index: 10;
    filter: drop-shadow(0 0 30px rgba(34, 197, 94, 0.5));
  }

  .matrix-subtitle {
    text-align: center;
    color: rgba(203, 213, 225, 0.9);
    margin-bottom: 5rem;
    font-size: 1.25rem;
    font-weight: 300;
    position: relative;
    z-index: 10;
  }

  .matrix-hud {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 10;
  }

  .hud-chip {
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    border: 1px solid rgba(34, 197, 94, 0.4);
    background: rgba(10, 20, 12, 0.6);
    color: rgba(187, 247, 208, 0.9);
    font-size: 0.75rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
  }

  .matrix-status {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(5, 15, 8, 0.6);
    color: rgba(187, 247, 208, 0.9);
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-family: var(--font-mono, ui-monospace);
    margin: 0 auto 2rem;
    width: fit-content;
    position: relative;
    z-index: 10;
  }

  .status-divider {
    width: 1px;
    height: 14px;
    background: rgba(255, 255, 255, 0.2);
  }

  .matrix-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 3rem;
    flex-wrap: wrap;
    position: relative;
    z-index: 10;
  }

  .matrix-btn.active {
    background: rgba(34, 197, 94, 0.25) !important;
    border-color: rgba(34, 197, 94, 0.7) !important;
    color: #fff !important;
    box-shadow: 0 0 30px rgba(34, 197, 94, 0.5) !important;
  }

  .matrix-container {
    perspective: 1500px;
    height: 600px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .matrix-overlay {
    position: absolute;
    inset: 0;
    background:
      radial-gradient(
        circle at 20% 20%,
        rgba(16, 185, 129, 0.15),
        transparent 40%
      ),
      radial-gradient(
        circle at 80% 70%,
        rgba(34, 197, 94, 0.12),
        transparent 45%
      );
    mix-blend-mode: screen;
    pointer-events: none;
    z-index: 2;
  }

  .matrix-scanlines {
    position: absolute;
    inset: 0;
    background-image: linear-gradient(
      transparent 0%,
      rgba(0, 0, 0, 0.15) 50%,
      transparent 100%
    );
    background-size: 100% 6px;
    opacity: 0.4;
    animation: scanScroll 8s linear infinite;
    pointer-events: none;
    z-index: 3;
  }

  @keyframes scanScroll {
    to {
      background-position: 0 100%;
    }
  }

  .matrix-scene {
    position: relative;
    width: 100%;
    max-width: 1200px;
    height: 100%;
    transform-style: preserve-3d;
    display: flex;
    justify-content: space-around;
    align-items: flex-start;
    z-index: 4;
  }

  .matrix-column {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation:
      columnFall var(--column-speed) linear infinite,
      columnSway 8s ease-in-out infinite;
    animation-delay: var(--column-delay);
    transform: translateZ(var(--column-depth));
    filter: blur(calc(abs(var(--column-depth)) / 100));
  }

  @keyframes columnFall {
    0% {
      transform: translateY(-100%) translateZ(var(--column-depth));
    }
    100% {
      transform: translateY(700px) translateZ(var(--column-depth));
    }
  }

  @keyframes columnSway {
    0%,
    100% {
      transform: translateX(0) translateZ(var(--column-depth));
    }
    50% {
      transform: translateX(10px) translateZ(var(--column-depth));
    }
  }

  .matrix-char {
    font-family: 'Courier New', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: #22c55e;
    text-align: center;
    text-shadow:
      0 0 10px rgba(34, 197, 94, 1),
      0 0 20px rgba(34, 197, 94, 0.8),
      0 0 30px rgba(34, 197, 94, 0.6);
    animation: charFlicker 0.5s ease-in-out infinite;
    animation-delay: calc(var(--column-delay) + var(--char-delay, 0s));
    opacity: 0.8;
  }

  .matrix-wrapper[data-glow='false'] .matrix-char {
    text-shadow: none;
  }

  .matrix-char:first-child {
    color: #fff;
    font-size: 2rem;
    text-shadow:
      0 0 20px rgba(255, 255, 255, 1),
      0 0 40px rgba(34, 197, 94, 1),
      0 0 60px rgba(34, 197, 94, 0.8);
    opacity: 1;
  }

  .matrix-char:nth-child(2),
  .matrix-char:nth-child(3) {
    color: #86efac;
  }

  .matrix-char:nth-last-child(-n + 3) {
    color: rgba(34, 197, 94, 0.4);
    text-shadow: 0 0 5px rgba(34, 197, 94, 0.6);
  }

  .matrix-wrapper[data-density='low'] .matrix-column:nth-child(n + 19),
  :global(html[data-demo-perf='true'])
    .matrix-wrapper
    .matrix-column:nth-child(n + 19) {
    display: none;
  }

  .matrix-wrapper[data-density='normal'] .matrix-column:nth-child(n + 27) {
    display: none;
  }

  @keyframes charFlicker {
    0%,
    100% {
      opacity: 0.6;
    }
    50% {
      opacity: 1;
    }
  }

  .matrix-core {
    position: absolute;
    width: 200px;
    height: 200px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: radial-gradient(
      circle,
      rgba(34, 197, 94, 0.4),
      rgba(34, 197, 94, 0.2),
      transparent
    );
    border-radius: 50%;
    animation: corePulse 4s ease-in-out infinite;
    filter: blur(40px);
  }

  @keyframes corePulse {
    0%,
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.3;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.5);
      opacity: 0.6;
    }
  }

  @media (max-width: 768px) {
    .matrix-title {
      font-size: 2.5rem;
    }

    .matrix-char {
      font-size: 1rem;
    }

    .matrix-char:first-child {
      font-size: 1.5rem;
    }

    .matrix-controls {
      gap: 0.5rem;
    }

    .matrix-status {
      font-size: 0.6rem;
      letter-spacing: 0.16em;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .matrix-wrapper::before,
    .matrix-column,
    .matrix-char,
    .matrix-core {
      animation: none !important;
      transition: none !important;
    }
    .matrix-scanlines {
      animation: none !important;
    }
    .matrix-container,
    .matrix-scene {
      perspective: none;
      transform: none;
    }
    .matrix-column {
      transform: translateZ(0);
    }
    .matrix-char {
      opacity: 0.8;
      text-shadow: none;
    }
  }
</style>

<script>
  import {
    getEffectiveDemoFlags,
    getDemoModuleRoot,
    isDemoPaused,
    observeDemoLabFlags,
  } from '@/utils/demo-lab';
  import { onReducedMotionChange, prefersReducedMotion } from '@/utils/a11y';

  if (typeof window !== 'undefined') {
    const characters =
      'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';

    function startMatrixFlicker(target: Element) {
      const moduleRoot = getDemoModuleRoot(target);
      let intervalId: number | null = null;
      let isVisible = true;

      const tick = () => {
        const chars = target.querySelectorAll<HTMLElement>('.matrix-char');
        chars.forEach(char => {
          if (Math.random() > 0.95) {
            char.textContent =
              characters[Math.floor(Math.random() * characters.length)];
          }
        });
      };

      const start = () => {
        if (isDemoPaused(moduleRoot)) return;
        if (!isVisible) return;
        if (intervalId !== null) return;
        const perfMode = getEffectiveDemoFlags(moduleRoot)?.perfMode;
        intervalId = window.setInterval(tick, perfMode ? 160 : 80);
      };

      const stop = () => {
        if (intervalId !== null) {
          clearInterval(intervalId);
          intervalId = null;
        }
      };

      const sync = () => {
        if (prefersReducedMotion() || isDemoPaused(moduleRoot) || !isVisible) {
          stop();
        } else {
          start();
        }
      };

      if (!prefersReducedMotion()) {
        const observer = new IntersectionObserver(
          entries => {
            entries.forEach(entry => {
              isVisible = Boolean(entry.isIntersecting);
              sync();
            });
          },
          { rootMargin: '200px' }
        );
        observer.observe(target);

        // React to Demo Lab toggles/offscreen pauser.
        const stopDemoObserver = observeDemoLabFlags(sync, {
          moduleRoot,
          includePerf: false,
        });

        const stopRMObserver = onReducedMotionChange(() => sync());

        // Ensure we stop everything when the page unloads.
        const cleanupAll = () => {
          stopDemoObserver();
          stopRMObserver();
          observer.disconnect();
          stop();
        };

        // Start only if visible + not paused.
        sync();

        return cleanupAll;
      }

      // Reduced motion: always off.
      return stop;
    }

    const matrixWrapper = document.querySelector(
      '.matrix-wrapper'
    ) as HTMLElement | null;
    const densityButtons = document.querySelectorAll('[data-density]');
    const glowButton = document.querySelector('[data-matrix-toggle="glow"]');
    const statusValue = document.querySelector('[data-matrix-status]');
    const glowValue = document.querySelector('[data-matrix-glow]');
    let cleanup: null | (() => void) = null;

    if (matrixWrapper) {
      const setDensityState = (active: Element) => {
        densityButtons.forEach(btn => {
          const pressed = btn === active;
          btn.classList.toggle('active', pressed);
          btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
        });
      };

      densityButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const density = btn.getAttribute('data-density') || 'normal';
          matrixWrapper.setAttribute('data-density', density);
          setDensityState(btn);
          if (statusValue) {
            statusValue.textContent =
              density === 'low'
                ? 'Low'
                : density === 'high'
                  ? 'High'
                  : 'Normal';
          }
        });
      });

      if (glowButton) {
        glowButton.addEventListener('click', () => {
          const next = matrixWrapper.dataset.glow !== 'true';
          matrixWrapper.dataset.glow = next ? 'true' : 'false';
          glowButton.classList.toggle('active', next);
          glowButton.setAttribute('aria-pressed', next ? 'true' : 'false');
          if (glowValue) {
            glowValue.textContent = next ? 'On' : 'Off';
          }
        });
      }

      const syncPerf = () => {
        const perf = getEffectiveDemoFlags(
          getDemoModuleRoot(matrixWrapper)
        )?.perfMode;
        if (perf) {
          matrixWrapper.dataset.density = 'low';
          matrixWrapper.dataset.glow = 'false';
          if (statusValue) statusValue.textContent = 'Low';
          if (glowValue) glowValue.textContent = 'Off';
        }
      };

      syncPerf();
      cleanup = startMatrixFlicker(matrixWrapper);

      const stopPerfObserver = observeDemoLabFlags(syncPerf, {
        moduleRoot: getDemoModuleRoot(matrixWrapper),
        includePerf: true,
      });

      window.addEventListener(
        'beforeunload',
        () => {
          stopPerfObserver();
        },
        { once: true }
      );
    }

    window.addEventListener(
      'beforeunload',
      () => {
        if (cleanup) cleanup();
      },
      { once: true }
    );
  }
</script>
