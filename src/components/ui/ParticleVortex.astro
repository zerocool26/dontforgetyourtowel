---
/**
 * Particle Vortex - 3D spiral of particles with physics
 * Enhanced with gravity simulation and mouse attraction
 */
import ModernButton from './ModernButton.astro';
---

<div class="vortex-wrapper">
  <h2 class="vortex-title">Particle Vortex</h2>
  <p class="vortex-subtitle">
    Interactive 3D spiral â€¢ Move mouse to attract particles
  </p>

  <div
    class="vortex-controls"
    role="group"
    aria-label="Particle vortex pattern controls"
  >
    <ModernButton
      variant="neon"
      className="vortex-btn active"
      data-mode="spiral"
      aria-pressed="true"
      aria-label="Spiral pattern">Spiral</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="sphere"
      aria-pressed="false"
      aria-label="Sphere pattern">Sphere</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="explosion"
      aria-pressed="false"
      aria-label="Explosion pattern">Explosion</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="chaos"
      aria-pressed="false"
      aria-label="Chaos pattern">Chaos</ModernButton
    >
  </div>

  <div class="vortex-container" data-vortex-interactive>
    <div class="vortex" data-vortex-system>
      {
        Array.from({ length: 120 }).map((_, i) => {
          const angle = (i / 120) * 360 * 6;
          const radius = 50 + (i / 120) * 300;
          const height = (i / 120) * 700 - 350;
          return (
            <div
              class="vortex-particle"
              data-particle
              style={`
              --angle: ${angle}deg;
              --radius: ${radius}px;
              --height: ${height}px;
              --delay: ${i * 0.03}s;
              --hue: ${(i / 120) * 360};
              --index: ${i};
            `}
            >
              <div class="particle-glow" />
              <div class="particle-trail" />
            </div>
          );
        })
      }

      {/* Core energy sphere with rings */}
      <div class="vortex-core">
        {
          Array.from({ length: 3 }).map((_, i) => (
            <div class="core-ring" style={`--ring-index: ${i}`} />
          ))
        }
      </div>

      {/* Energy field */}
      <div class="energy-field"></div>
    </div>
  </div>
</div>

<style>
  .vortex-wrapper {
    content-visibility: auto;
    contain: layout paint style;
    contain-intrinsic-size: 800px;
    padding: 8rem 2rem;
    background: radial-gradient(
      ellipse at center,
      rgba(139, 92, 246, 0.15),
      transparent
    );
    min-height: 800px;
    position: relative;
    overflow: hidden;
  }

  .vortex-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(
        circle at 30% 40%,
        rgba(168, 85, 247, 0.1),
        transparent 60%
      ),
      radial-gradient(
        circle at 70% 60%,
        rgba(59, 130, 246, 0.1),
        transparent 60%
      );
    animation: backgroundShift 10s ease-in-out infinite;
  }

  @keyframes backgroundShift {
    0%,
    100% {
      opacity: 0.5;
      transform: rotate(0deg);
    }
    50% {
      opacity: 1;
      transform: rotate(180deg);
    }
  }

  .vortex-title {
    font-size: 4rem;
    font-weight: 900;
    text-align: center;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
    position: relative;
    z-index: 10;
  }

  .vortex-subtitle {
    text-align: center;
    color: rgba(203, 213, 225, 0.9);
    margin-bottom: 5rem;
    font-size: 1.25rem;
    font-weight: 300;
    position: relative;
    z-index: 10;
  }

  .vortex-container {
    perspective: 2000px;
    height: 700px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 5;
  }

  .vortex {
    position: relative;
    width: 600px;
    height: 700px;
    transform-style: preserve-3d;
    animation: vortexSpin 30s linear infinite;
  }

  @keyframes vortexSpin {
    0% {
      transform: rotateY(0deg) rotateX(20deg);
    }
    100% {
      transform: rotateY(360deg) rotateX(20deg);
    }
  }

  .vortex-particle {
    position: absolute;
    width: 12px;
    height: 12px;
    left: 50%;
    top: 50%;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      hsl(var(--hue), 80%, 60%),
      hsl(var(--hue), 70%, 50%)
    );
    transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
      translateX(var(--radius)) translateZ(var(--height));
    box-shadow:
      0 0 20px hsl(var(--hue), 80%, 60%),
      0 0 40px hsl(var(--hue), 70%, 50%);
    animation: particlePulse 2s ease-in-out infinite;
    animation-delay: var(--delay);
  }

  @keyframes particlePulse {
    0%,
    100% {
      transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
        translateX(var(--radius)) translateZ(var(--height)) scale(1);
    }
    50% {
      transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
        translateX(var(--radius)) translateZ(var(--height)) scale(1.5);
    }
  }

  .vortex-core {
    position: absolute;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(139, 92, 246, 1),
      rgba(168, 85, 247, 0.8),
      rgba(59, 130, 246, 0.4)
    );
    box-shadow:
      0 0 60px rgba(139, 92, 246, 1),
      0 0 120px rgba(168, 85, 247, 0.8),
      inset 0 0 40px rgba(255, 255, 255, 0.5);
    animation:
      coreRotate 10s linear infinite,
      corePulse 3s ease-in-out infinite;
  }

  @keyframes coreRotate {
    0% {
      transform: translate(-50%, -50%) rotate(0deg);
    }
    100% {
      transform: translate(-50%, -50%) rotate(360deg);
    }
  }

  @keyframes corePulse {
    0%,
    100% {
      box-shadow:
        0 0 60px rgba(139, 92, 246, 1),
        0 0 120px rgba(168, 85, 247, 0.8),
        inset 0 0 40px rgba(255, 255, 255, 0.5);
    }
    50% {
      box-shadow:
        0 0 100px rgba(139, 92, 246, 1),
        0 0 180px rgba(168, 85, 247, 1),
        inset 0 0 60px rgba(255, 255, 255, 0.8);
    }
  }

  .vortex-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }

  /* .vortex-btn styles replaced by ModernButton variant="neon" */

  .vortex-btn.active {
    background: rgba(139, 92, 246, 0.3) !important;
    border-color: rgba(139, 92, 246, 0.8) !important;
    color: #fff !important;
    box-shadow: 0 0 30px rgba(139, 92, 246, 0.6) !important;
  }

  .particle-glow {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      hsla(var(--hue), 80%, 60%, 0.6),
      transparent
    );
    filter: blur(8px);
  }

  .particle-trail {
    position: absolute;
    width: 2px;
    height: 30px;
    left: 50%;
    bottom: 100%;
    transform: translateX(-50%);
    background: linear-gradient(
      to top,
      hsla(var(--hue), 80%, 60%, 0.8),
      transparent
    );
    filter: blur(1px);
  }

  .core-ring {
    position: absolute;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    animation: ringExpand 3s ease-in-out infinite;
    animation-delay: calc(var(--ring-index) * 0.5s);
  }

  @keyframes ringExpand {
    0% {
      inset: 50%;
      opacity: 1;
    }
    100% {
      inset: -50%;
      opacity: 0;
    }
  }

  .energy-field {
    position: absolute;
    inset: -200px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(139, 92, 246, 0.1),
      transparent 70%
    );
    animation: fieldPulse 5s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes fieldPulse {
    0%,
    100% {
      opacity: 0.3;
      transform: scale(1);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.2);
    }
  }

  @media (max-width: 768px) {
    .vortex-title {
      font-size: 2.5rem;
    }

    .vortex {
      width: 400px;
      height: 500px;
    }

    .vortex-particle {
      width: 8px;
      height: 8px;
    }

    .vortex-core {
      width: 60px;
      height: 60px;
    }

    .vortex-controls {
      gap: 0.5rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .vortex,
    .vortex::before,
    .vortex::after,
    .vortex-container,
    .vortex-particle,
    .particle-glow,
    .particle-trail,
    .vortex-core,
    .core-ring,
    .energy-field,
    .vortex-wrapper::before {
      animation: none !important;
      transition: none !important;
    }
    .vortex {
      transform: none;
    }
  }
</style>

<script>
  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  );

  const vortexContainer = document.querySelector(
    '[data-vortex-interactive]'
  ) as HTMLElement;
  const vortexSystem = document.querySelector(
    '[data-vortex-system]'
  ) as HTMLElement;
  const particles = document.querySelectorAll(
    '[data-particle]'
  ) as NodeListOf<HTMLElement>;
  const buttons = document.querySelectorAll('.vortex-btn');

  const moduleRoot = (vortexContainer?.closest('[data-demo-module]') ||
    vortexContainer?.closest('.demo-module')) as HTMLElement | null;

  const usesDemoLabControls = Boolean(moduleRoot);

  const isDemoPaused = () => {
    if (!usesDemoLabControls) return false;
    const html = document.documentElement;
    const htmlPaused = html.dataset.demoPaused === 'true';
    const htmlReduced = html.dataset.demoReducedMotion === 'true';
    const modPaused = moduleRoot?.dataset.demoPaused === 'true';
    const modReduced = moduleRoot?.dataset.demoReducedMotion === 'true';
    return htmlPaused || htmlReduced || modPaused || modReduced;
  };

  const isDemoPerf = () => {
    if (!usesDemoLabControls) return false;
    const html = document.documentElement;
    return (
      html.dataset.demoPerf === 'true' ||
      moduleRoot?.dataset.demoPerf === 'true'
    );
  };

  const isInteractiveAllowed = () => {
    if (prefersReducedMotion.matches) return false;
    if (isDemoPaused()) return false;
    return true;
  };

  const setModeButtonState = (activeBtn: Element) => {
    buttons.forEach(b => {
      const pressed = b === activeBtn;
      b.classList.toggle('active', pressed);
      b.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    });
  };

  const applyMode = (mode: string) => {
    const count = particles.length;
    particles.forEach((particle, i) => {
      const angle = (i / count) * 360 * 6;
      const baseRadius = 50 + (i / count) * 300;
      const baseHeight = (i / count) * 700 - 350;

      switch (mode) {
        case 'sphere': {
          const phi = Math.acos(-1 + (2 * i) / count);
          const theta = Math.sqrt(count * Math.PI) * phi;
          particle.style.setProperty('--radius', `${Math.sin(phi) * 250}px`);
          particle.style.setProperty('--height', `${Math.cos(phi) * 250}px`);
          particle.style.setProperty(
            '--angle',
            `${(theta * 180) / Math.PI}deg`
          );
          break;
        }
        case 'explosion':
          particle.style.setProperty('--radius', `${baseRadius * 2}px`);
          particle.style.setProperty('--height', `${baseHeight * 2}px`);
          break;
        case 'chaos':
          particle.style.setProperty('--radius', `${Math.random() * 400}px`);
          particle.style.setProperty(
            '--height',
            `${Math.random() * 800 - 400}px`
          );
          particle.style.setProperty('--angle', `${Math.random() * 360}deg`);
          break;
        default: // spiral
          particle.style.setProperty('--radius', `${baseRadius}px`);
          particle.style.setProperty('--height', `${baseHeight}px`);
          particle.style.setProperty('--angle', `${angle}deg`);
      }
    });

    if (vortexSystem) {
      vortexSystem.style.animationDuration = mode === 'chaos' ? '15s' : '30s';
    }
  };

  // Mode controls are safe to keep enabled; they don't run continuously.
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      setModeButtonState(btn);
      const mode = btn.getAttribute('data-mode') || 'spiral';
      applyMode(mode);
    });
  });

  let isInteractiveBound = false;

  let lastX = 0;
  let lastY = 0;
  let hasPointer = false;
  let rafId: number | null = null;

  const cancelFrame = () => {
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
  };

  const renderFrame = () => {
    rafId = null;

    if (!vortexContainer) return;
    if (!hasPointer) return;

    const rotateX = lastY * 40;
    const rotateY = lastX * 40;
    vortexContainer.style.transform = `perspective(2000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

    // Perf mode: avoid per-particle work (still looks lively via CSS spin/pulse).
    if (isDemoPerf()) return;

    const now = Date.now() * 0.001;
    const scale = 1 + Math.abs(lastX + lastY) * 0.3;

    for (let i = 0; i < particles.length; i++) {
      const particle = particles[i];
      const t = now + i * 0.02;
      const attractionX = lastX * 50 * Math.sin(t + i);
      const attractionY = lastY * 50 * Math.cos(t + i);

      particle.style.transform = `
          translateX(-50%)
          translateY(-50%)
          rotateY(var(--angle))
          translateX(calc(var(--radius) + ${attractionX}px))
          translateZ(calc(var(--height) + ${attractionY}px))
          scale(${scale})
        `;
    }
  };

  const requestFrame = () => {
    if (rafId !== null) return;
    rafId = requestAnimationFrame(renderFrame);
  };

  const onMouseMove = (e: MouseEvent) => {
    if (!vortexContainer) return;
    const rect = vortexContainer.getBoundingClientRect();
    lastX = (e.clientX - rect.left) / rect.width - 0.5;
    lastY = (e.clientY - rect.top) / rect.height - 0.5;
    hasPointer = true;
    requestFrame();
  };

  const onMouseLeave = () => {
    if (!vortexContainer) return;
    hasPointer = false;
    cancelFrame();
    vortexContainer.style.transform =
      'perspective(2000px) rotateX(0) rotateY(0)';
    particles.forEach(particle => {
      particle.style.transform = '';
    });
  };

  const bindInteractive = () => {
    if (isInteractiveBound) return;
    if (!vortexContainer || !vortexSystem) return;
    vortexContainer.addEventListener('mousemove', onMouseMove);
    vortexContainer.addEventListener('mouseleave', onMouseLeave);
    isInteractiveBound = true;
  };

  const unbindInteractive = () => {
    if (!isInteractiveBound) return;
    if (!vortexContainer) return;
    vortexContainer.removeEventListener('mousemove', onMouseMove);
    vortexContainer.removeEventListener('mouseleave', onMouseLeave);
    onMouseLeave();
    isInteractiveBound = false;
  };

  const syncInteractive = () => {
    if (isInteractiveAllowed()) bindInteractive();
    else unbindInteractive();
  };

  if (vortexContainer && vortexSystem) {
    syncInteractive();

    // React to Demo Lab toggles / offscreen pauser.
    if (usesDemoLabControls) {
      const observer = new MutationObserver(syncInteractive);
      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: [
          'data-demo-paused',
          'data-demo-reduced-motion',
          'data-demo-perf',
        ],
      });
      if (moduleRoot) {
        observer.observe(moduleRoot, {
          attributes: true,
          attributeFilter: [
            'data-demo-paused',
            'data-demo-reduced-motion',
            'data-demo-perf',
          ],
        });
      }
      const onRMChange = () => syncInteractive();
      if ('addEventListener' in prefersReducedMotion) {
        prefersReducedMotion.addEventListener('change', onRMChange);
      } else {
        // @ts-expect-error older Safari
        prefersReducedMotion.addListener(onRMChange);
      }

      window.addEventListener(
        'beforeunload',
        () => {
          observer.disconnect();
          unbindInteractive();
          if ('removeEventListener' in prefersReducedMotion) {
            prefersReducedMotion.removeEventListener('change', onRMChange);
          } else {
            // @ts-expect-error older Safari
            prefersReducedMotion.removeListener(onRMChange);
          }
        },
        { once: true }
      );
    }
  }
</script>
