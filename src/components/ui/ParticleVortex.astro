---
/**
 * Particle Vortex - 3D spiral of particles with physics
 * Enhanced with gravity simulation and mouse attraction
 */
import ModernButton from './ModernButton.astro';
---

<div class="vortex-wrapper">
  <h2 class="vortex-title">Particle Vortex</h2>
  <p class="vortex-subtitle">
    Interactive 3D spiral â€¢ Move mouse to attract particles
  </p>

  <div class="vortex-status" aria-live="polite">
    <span class="status-label">Mode</span>
    <span class="status-value" data-vortex-status>Spiral</span>
    <span class="status-divider" aria-hidden="true"></span>
    <span class="status-label">Field</span>
    <span class="status-value" data-vortex-field>On</span>
  </div>

  <div class="vortex-hud" aria-hidden="true">
    <div class="hud-pill">Live field</div>
    <div class="hud-pill">Magnetic arcs</div>
    <div class="hud-pill">Mode adaptive</div>
  </div>

  <div
    class="vortex-controls"
    role="group"
    aria-label="Particle vortex pattern controls"
  >
    <ModernButton
      variant="neon"
      className="vortex-btn active"
      data-mode="spiral"
      aria-pressed="true"
      aria-label="Spiral pattern">Spiral</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="sphere"
      aria-pressed="false"
      aria-label="Sphere pattern">Sphere</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="explosion"
      aria-pressed="false"
      aria-label="Explosion pattern">Explosion</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-mode="chaos"
      aria-pressed="false"
      aria-label="Chaos pattern">Chaos</ModernButton
    >
    <ModernButton
      variant="neon"
      className="vortex-btn"
      data-vortex-toggle="field"
      aria-pressed="true"
      aria-label="Toggle energy field">Field</ModernButton
    >
  </div>

  <div class="vortex-container" data-vortex-interactive data-field="true">
    <div class="vortex" data-vortex-system data-mode="spiral">
      {
        Array.from({ length: 120 }).map((_, i) => {
          const angle = (i / 120) * 360 * 6;
          const radius = 50 + (i / 120) * 300;
          const height = (i / 120) * 700 - 350;
          return (
            <div
              class="vortex-particle"
              data-particle
              style={`
              --angle: ${angle}deg;
              --radius: ${radius}px;
              --height: ${height}px;
              --delay: ${i * 0.03}s;
              --hue: ${(i / 120) * 360};
              --index: ${i};
            `}
            >
              <div class="particle-glow" />
              <div class="particle-trail" />
            </div>
          );
        })
      }

      {/* Core energy sphere with rings */}
      <div class="vortex-core">
        {
          Array.from({ length: 3 }).map((_, i) => (
            <div class="core-ring" style={`--ring-index: ${i}`} />
          ))
        }
      </div>

      <div class="vortex-lattice" aria-hidden="true"></div>
      <div class="vortex-streaks" aria-hidden="true">
        {Array.from({ length: 8 }).map(() => <span class="streak" />)}
      </div>

      <div class="vortex-grid" aria-hidden="true"></div>

      <div class="vortex-arc arc-1" aria-hidden="true"></div>
      <div class="vortex-arc arc-2" aria-hidden="true"></div>
      <div class="vortex-arc arc-3" aria-hidden="true"></div>

      {/* Energy field */}
      <div class="energy-field"></div>
    </div>
  </div>
</div>

<style>
  .vortex-wrapper {
    content-visibility: auto;
    contain: layout paint style;
    contain-intrinsic-size: 800px;
    padding: 8rem 2rem;
    background: radial-gradient(
      ellipse at center,
      rgba(139, 92, 246, 0.15),
      transparent
    );
    min-height: 800px;
    position: relative;
    overflow: hidden;
  }

  .vortex-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(
        circle at 30% 40%,
        rgba(168, 85, 247, 0.1),
        transparent 60%
      ),
      radial-gradient(
        circle at 70% 60%,
        rgba(59, 130, 246, 0.1),
        transparent 60%
      );
    animation: backgroundShift 10s ease-in-out infinite;
  }

  @keyframes backgroundShift {
    0%,
    100% {
      opacity: 0.5;
      transform: rotate(0deg);
    }
    50% {
      opacity: 1;
      transform: rotate(180deg);
    }
  }

  .vortex-title {
    font-size: 4rem;
    font-weight: 900;
    text-align: center;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 50%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
    position: relative;
    z-index: 10;
  }

  .vortex-subtitle {
    text-align: center;
    color: rgba(203, 213, 225, 0.9);
    margin-bottom: 5rem;
    font-size: 1.25rem;
    font-weight: 300;
    position: relative;
    z-index: 10;
  }

  .vortex-hud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 10;
  }

  .hud-pill {
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(15, 23, 42, 0.55);
    color: rgba(226, 232, 240, 0.9);
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .vortex-status {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(15, 23, 42, 0.5);
    color: rgba(226, 232, 240, 0.85);
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-family: var(--font-mono, ui-monospace);
    margin: 0 auto 2.5rem;
    width: fit-content;
    position: relative;
    z-index: 10;
  }

  .status-divider {
    width: 1px;
    height: 14px;
    background: rgba(255, 255, 255, 0.2);
  }

  .vortex-container {
    perspective: 2000px;
    height: 700px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 5;
  }

  .vortex {
    position: relative;
    width: 600px;
    height: 700px;
    transform-style: preserve-3d;
    animation: vortexSpin 30s linear infinite;
  }

  .vortex-lattice {
    position: absolute;
    inset: 12% 18%;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: radial-gradient(
      circle,
      rgba(168, 85, 247, 0.15),
      transparent 65%
    );
    transform: translateZ(-160px);
    animation: latticeSpin 18s linear infinite;
    pointer-events: none;
  }

  .vortex-streaks {
    position: absolute;
    inset: -20% 0;
    pointer-events: none;
  }

  .streak {
    position: absolute;
    width: 2px;
    height: 140px;
    background: linear-gradient(
      to bottom,
      transparent,
      rgba(139, 92, 246, 0.6),
      transparent
    );
    animation: streakDrift 6s ease-in-out infinite;
  }

  .streak:nth-child(1) {
    left: 20%;
    animation-delay: 0s;
  }
  .streak:nth-child(2) {
    left: 35%;
    animation-delay: 0.8s;
  }
  .streak:nth-child(3) {
    left: 50%;
    animation-delay: 1.6s;
  }
  .streak:nth-child(4) {
    left: 65%;
    animation-delay: 2.4s;
  }
  .streak:nth-child(5) {
    left: 80%;
    animation-delay: 3.2s;
  }
  .streak:nth-child(6) {
    left: 15%;
    animation-delay: 4s;
  }
  .streak:nth-child(7) {
    left: 60%;
    animation-delay: 4.8s;
  }
  .streak:nth-child(8) {
    left: 75%;
    animation-delay: 5.6s;
  }

  .vortex[data-mode='sphere'] {
    animation-duration: 22s;
  }

  .vortex[data-mode='explosion'] {
    animation-duration: 18s;
  }

  .vortex[data-mode='chaos'] {
    animation-duration: 12s;
  }

  @keyframes vortexSpin {
    0% {
      transform: rotateY(0deg) rotateX(20deg);
    }
    100% {
      transform: rotateY(360deg) rotateX(20deg);
    }
  }

  @keyframes latticeSpin {
    to {
      transform: translateZ(-160px) rotate(360deg);
    }
  }

  @keyframes streakDrift {
    0%,
    100% {
      transform: translateY(0);
      opacity: 0.2;
    }
    50% {
      transform: translateY(-30px);
      opacity: 0.6;
    }
  }

  .vortex-particle {
    position: absolute;
    width: 12px;
    height: 12px;
    left: 50%;
    top: 50%;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      hsl(var(--hue), 80%, 60%),
      hsl(var(--hue), 70%, 50%)
    );
    transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
      translateX(var(--radius)) translateZ(var(--height));
    box-shadow:
      0 0 20px hsl(var(--hue), 80%, 60%),
      0 0 40px hsl(var(--hue), 70%, 50%);
    animation: particlePulse 2s ease-in-out infinite;
    animation-delay: var(--delay);
  }

  @keyframes particlePulse {
    0%,
    100% {
      transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
        translateX(var(--radius)) translateZ(var(--height)) scale(1);
    }
    50% {
      transform: translateX(-50%) translateY(-50%) rotateY(var(--angle))
        translateX(var(--radius)) translateZ(var(--height)) scale(1.5);
    }
  }

  .vortex-core {
    position: absolute;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(139, 92, 246, 1),
      rgba(168, 85, 247, 0.8),
      rgba(59, 130, 246, 0.4)
    );
    box-shadow:
      0 0 60px rgba(139, 92, 246, 1),
      0 0 120px rgba(168, 85, 247, 0.8),
      inset 0 0 40px rgba(255, 255, 255, 0.5);
    animation:
      coreRotate 10s linear infinite,
      corePulse 3s ease-in-out infinite;
  }

  .vortex-grid {
    position: absolute;
    inset: 10% 15%;
    border-radius: 50%;
    background-image: radial-gradient(
      rgba(255, 255, 255, 0.08) 1px,
      transparent 1px
    );
    background-size: 24px 24px;
    opacity: 0.3;
    transform: translateZ(-200px);
    animation: gridDrift 12s ease-in-out infinite;
  }

  @keyframes gridDrift {
    0%,
    100% {
      transform: translateZ(-200px) rotate(0deg);
      opacity: 0.2;
    }
    50% {
      transform: translateZ(-200px) rotate(25deg);
      opacity: 0.45;
    }
  }

  .vortex-arc {
    position: absolute;
    inset: 5% 12%;
    border-radius: 50%;
    border: 1px dashed rgba(59, 130, 246, 0.5);
    animation: arcPulse 6s ease-in-out infinite;
    pointer-events: none;
  }

  .vortex-arc.arc-2 {
    inset: 15% 20%;
    border-color: rgba(168, 85, 247, 0.55);
    animation-delay: 1.5s;
  }

  .vortex-arc.arc-3 {
    inset: 25% 28%;
    border-color: rgba(34, 211, 238, 0.5);
    animation-delay: 3s;
  }

  @keyframes arcPulse {
    0%,
    100% {
      opacity: 0.2;
      transform: scale(0.98);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.04);
    }
  }

  @keyframes coreRotate {
    0% {
      transform: translate(-50%, -50%) rotate(0deg);
    }
    100% {
      transform: translate(-50%, -50%) rotate(360deg);
    }
  }

  @keyframes corePulse {
    0%,
    100% {
      box-shadow:
        0 0 60px rgba(139, 92, 246, 1),
        0 0 120px rgba(168, 85, 247, 0.8),
        inset 0 0 40px rgba(255, 255, 255, 0.5);
    }
    50% {
      box-shadow:
        0 0 100px rgba(139, 92, 246, 1),
        0 0 180px rgba(168, 85, 247, 1),
        inset 0 0 60px rgba(255, 255, 255, 0.8);
    }
  }

  .vortex-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }

  /* .vortex-btn styles replaced by ModernButton variant="neon" */

  .vortex-btn.active {
    background: rgba(139, 92, 246, 0.3) !important;
    border-color: rgba(139, 92, 246, 0.8) !important;
    color: #fff !important;
    box-shadow: 0 0 30px rgba(139, 92, 246, 0.6) !important;
  }

  .particle-glow {
    position: absolute;
    inset: -10px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      hsla(var(--hue), 80%, 60%, 0.6),
      transparent
    );
    filter: blur(8px);
  }

  .particle-trail {
    position: absolute;
    width: 2px;
    height: 30px;
    left: 50%;
    bottom: 100%;
    transform: translateX(-50%);
    background: linear-gradient(
      to top,
      hsla(var(--hue), 80%, 60%, 0.8),
      transparent
    );
    filter: blur(1px);
  }

  .core-ring {
    position: absolute;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    animation: ringExpand 3s ease-in-out infinite;
    animation-delay: calc(var(--ring-index) * 0.5s);
  }

  @keyframes ringExpand {
    0% {
      inset: 50%;
      opacity: 1;
    }
    100% {
      inset: -50%;
      opacity: 0;
    }
  }

  .energy-field {
    position: absolute;
    inset: -200px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(139, 92, 246, 0.1),
      transparent 70%
    );
    animation: fieldPulse 5s ease-in-out infinite;
    pointer-events: none;
  }

  .vortex-container[data-field='false'] .energy-field,
  .vortex-container[data-field='false'] .vortex-arc,
  .vortex-container[data-field='false'] .vortex-streaks,
  .vortex-container[data-field='false'] .particle-trail {
    display: none;
  }

  @keyframes fieldPulse {
    0%,
    100% {
      opacity: 0.3;
      transform: scale(1);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.2);
    }
  }

  @media (max-width: 768px) {
    .vortex-title {
      font-size: 2.5rem;
    }

    .vortex {
      width: 400px;
      height: 500px;
    }

    .vortex-particle {
      width: 8px;
      height: 8px;
    }

    .vortex-core {
      width: 60px;
      height: 60px;
    }

    .vortex-controls {
      gap: 0.5rem;
    }

    .vortex-status {
      font-size: 0.6rem;
      letter-spacing: 0.16em;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .vortex,
    .vortex::before,
    .vortex::after,
    .vortex-container,
    .vortex-particle,
    .particle-glow,
    .particle-trail,
    .vortex-core,
    .core-ring,
    .energy-field,
    .vortex-wrapper::before {
      animation: none !important;
      transition: none !important;
    }
    .vortex {
      transform: none;
    }
    .vortex-grid,
    .vortex-arc {
      animation: none !important;
    }
  }

  :global(html[data-demo-perf='true']) .vortex-container .streak,
  :global(html[data-demo-perf='true']) .vortex-container .vortex-lattice {
    animation: none !important;
    opacity: 0.2;
  }
</style>

<script>
  import {
    getDemoModuleRoot,
    getEffectiveDemoFlags,
    observeDemoLabFlags,
  } from '@/utils/demo-lab';
  import { onReducedMotionChange, prefersReducedMotion } from '@/utils/a11y';

  const vortexContainer = document.querySelector(
    '[data-vortex-interactive]'
  ) as HTMLElement;
  const vortexSystem = document.querySelector(
    '[data-vortex-system]'
  ) as HTMLElement;
  const particles = document.querySelectorAll(
    '[data-particle]'
  ) as NodeListOf<HTMLElement>;
  const buttons = document.querySelectorAll('.vortex-btn');
  const statusValue = document.querySelector('[data-vortex-status]');
  const fieldValue = document.querySelector('[data-vortex-field]');

  const moduleRoot = vortexContainer
    ? getDemoModuleRoot(vortexContainer)
    : null;

  const usesDemoLabControls = Boolean(moduleRoot);

  const getFlags = () =>
    usesDemoLabControls ? getEffectiveDemoFlags(moduleRoot) : null;

  const isInteractiveAllowed = () => {
    if (prefersReducedMotion()) return false;
    if (getFlags()?.paused) return false;
    return true;
  };

  const setModeButtonState = (activeBtn: Element) => {
    buttons.forEach(b => {
      const pressed = b === activeBtn;
      b.classList.toggle('active', pressed);
      b.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    });
  };

  const applyMode = (mode: string) => {
    const count = particles.length;
    particles.forEach((particle, i) => {
      const angle = (i / count) * 360 * 6;
      const baseRadius = 50 + (i / count) * 300;
      const baseHeight = (i / count) * 700 - 350;

      switch (mode) {
        case 'sphere': {
          const phi = Math.acos(-1 + (2 * i) / count);
          const theta = Math.sqrt(count * Math.PI) * phi;
          particle.style.setProperty('--radius', `${Math.sin(phi) * 250}px`);
          particle.style.setProperty('--height', `${Math.cos(phi) * 250}px`);
          particle.style.setProperty(
            '--angle',
            `${(theta * 180) / Math.PI}deg`
          );
          break;
        }
        case 'explosion':
          particle.style.setProperty('--radius', `${baseRadius * 2}px`);
          particle.style.setProperty('--height', `${baseHeight * 2}px`);
          break;
        case 'chaos':
          particle.style.setProperty('--radius', `${Math.random() * 400}px`);
          particle.style.setProperty(
            '--height',
            `${Math.random() * 800 - 400}px`
          );
          particle.style.setProperty('--angle', `${Math.random() * 360}deg`);
          break;
        default: // spiral
          particle.style.setProperty('--radius', `${baseRadius}px`);
          particle.style.setProperty('--height', `${baseHeight}px`);
          particle.style.setProperty('--angle', `${angle}deg`);
      }
    });

    if (vortexSystem) {
      vortexSystem.style.animationDuration = mode === 'chaos' ? '15s' : '30s';
      vortexSystem.dataset.mode = mode;
    }
  };

  // Mode controls are safe to keep enabled; they don't run continuously.
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.getAttribute('data-vortex-toggle') === 'field') {
        if (!vortexContainer) return;
        const next = vortexContainer.dataset.field !== 'true';
        vortexContainer.dataset.field = next ? 'true' : 'false';
        btn.classList.toggle('active', next);
        btn.setAttribute('aria-pressed', next ? 'true' : 'false');
        if (fieldValue) {
          fieldValue.textContent = next ? 'On' : 'Off';
        }
        return;
      }
      setModeButtonState(btn);
      const mode = btn.getAttribute('data-mode') || 'spiral';
      applyMode(mode);
      if (statusValue) {
        statusValue.textContent =
          mode === 'sphere'
            ? 'Sphere'
            : mode === 'explosion'
              ? 'Burst'
              : mode === 'chaos'
                ? 'Chaos'
                : 'Spiral';
      }
    });
  });

  let isInteractiveBound = false;

  let lastX = 0;
  let lastY = 0;
  let hasPointer = false;
  let rafId: number | null = null;

  const cancelFrame = () => {
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
  };

  const renderFrame = () => {
    rafId = null;

    if (!vortexContainer) return;
    if (!hasPointer) return;

    lastX += (targetX - lastX) * 0.12;
    lastY += (targetY - lastY) * 0.12;

    const rotateX = lastY * 40;
    const rotateY = lastX * 40;
    vortexContainer.style.transform = `perspective(2000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

    // Perf mode: avoid per-particle work (still looks lively via CSS spin/pulse).
    if (getFlags()?.perfMode) return;

    const now = Date.now() * 0.001;
    const scale = 1 + Math.abs(lastX + lastY) * 0.3;

    for (let i = 0; i < particles.length; i++) {
      const particle = particles[i];
      const t = now + i * 0.02;
      const attractionX = lastX * 50 * Math.sin(t + i);
      const attractionY = lastY * 50 * Math.cos(t + i);

      particle.style.transform = `
          translateX(-50%)
          translateY(-50%)
          rotateY(var(--angle))
          translateX(calc(var(--radius) + ${attractionX}px))
          translateZ(calc(var(--height) + ${attractionY}px))
          scale(${scale})
        `;
    }
  };

  const requestFrame = () => {
    if (rafId !== null) return;
    rafId = requestAnimationFrame(renderFrame);
  };

  let targetX = 0;
  let targetY = 0;

  const onPointerMove = (e: PointerEvent | MouseEvent) => {
    if (!vortexContainer) return;
    const rect = vortexContainer.getBoundingClientRect();
    targetX = (e.clientX - rect.left) / rect.width - 0.5;
    targetY = (e.clientY - rect.top) / rect.height - 0.5;
    hasPointer = true;
    requestFrame();
  };

  const onMouseLeave = () => {
    if (!vortexContainer) return;
    hasPointer = false;
    cancelFrame();
    vortexContainer.style.transform =
      'perspective(2000px) rotateX(0) rotateY(0)';
    particles.forEach(particle => {
      particle.style.transform = '';
    });
  };

  const bindInteractive = () => {
    if (isInteractiveBound) return;
    if (!vortexContainer || !vortexSystem) return;
    vortexContainer.addEventListener('pointermove', onPointerMove, {
      passive: true,
    });
    vortexContainer.addEventListener('pointerleave', onMouseLeave, {
      passive: true,
    });
    isInteractiveBound = true;
  };

  const unbindInteractive = () => {
    if (!isInteractiveBound) return;
    if (!vortexContainer) return;
    vortexContainer.removeEventListener('pointermove', onPointerMove);
    vortexContainer.removeEventListener('pointerleave', onMouseLeave);
    onMouseLeave();
    isInteractiveBound = false;
  };

  const syncInteractive = () => {
    if (isInteractiveAllowed()) bindInteractive();
    else unbindInteractive();
  };

  if (vortexContainer && vortexSystem) {
    syncInteractive();

    // React to Demo Lab toggles / offscreen pauser.
    if (usesDemoLabControls) {
      const stopDemoObserver = observeDemoLabFlags(syncInteractive, {
        moduleRoot,
        includePerf: true,
      });
      const stopRMObserver = onReducedMotionChange(() => syncInteractive());

      window.addEventListener(
        'beforeunload',
        () => {
          stopDemoObserver();
          stopRMObserver();
          unbindInteractive();
        },
        { once: true }
      );
    }
  }
</script>
