---
import { getCollection } from 'astro:content';
import { withBasePath } from '../../utils/helpers';

interface Props {
  activeTag?: string;
  className?: string;
}

const { activeTag, className = '' } = Astro.props;

// The MSP site has blog routes disabled; this tag cloud is scoped to case studies.
const caseStudies = await getCollection('caseStudies');
const tags = caseStudies.flatMap(entry => [
  entry.data.industry,
  ...(entry.data.tags || []),
]);
const tagCounts = tags.reduce(
  (acc, tag) => {
    acc[tag] = (acc[tag] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>
);

const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
---

<div class={`flex flex-wrap gap-2 ${className}`}>
  <a
    href={withBasePath('services/#case-studies')}
    class={`px-3 py-1 rounded-full text-xs font-medium transition-colors border ${
      !activeTag
        ? 'bg-indigo-600 text-white border-indigo-500'
        : 'bg-slate-800/50 text-slate-300 border-slate-700 hover:border-slate-500 hover:text-white'
    }`}
  >
    All
  </a>
  {
    sortedTags.map(([tag, count]) => {
      const isActive = tag === activeTag;
      return (
        <a
          href={withBasePath(
            `services/#case-studies?tag=${encodeURIComponent(tag)}`
          )}
          class={`rounded-full border px-3 py-1 text-xs font-medium transition-colors ${
            isActive
              ? 'border-indigo-500 bg-indigo-600 text-white'
              : 'border-slate-700 bg-slate-800/50 text-slate-300 hover:border-slate-500 hover:text-white'
          }`}
        >
          {tag} <span class="ml-1 opacity-60">({count})</span>
        </a>
      );
    })
  }
</div>
