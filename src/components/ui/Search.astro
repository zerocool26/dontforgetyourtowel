---
/**
 * Search Component
 * Client-side search for site content using Fuse.js.
 * Uses the shared `search-index.json` endpoint.
 */

import { withBasePath } from '../../utils/helpers';

export interface Props {
  placeholder?: string;
  maxResults?: number;
  class?: string;
}

const {
  placeholder = 'Search site...',
  maxResults = 5,
  class: className = '',
} = Astro.props;

const indexUrl = withBasePath('search-index.json');
const searchId = `search-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  class={`search-wrapper ${className}`}
  data-search-wrapper
  data-index-url={indexUrl}
  data-max-results={maxResults}
>
  <div class="relative" role="search">
    <label for={searchId} class="sr-only">Search site</label>
    <input
      aria-label="Search site"
      type="search"
      id={searchId}
      placeholder={placeholder}
      class="w-full rounded-lg border border-slate-700 bg-slate-800/50 px-4 py-3 pl-12 pr-16 text-slate-200 placeholder-slate-400 transition-all focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500"
      aria-describedby={`${searchId}-hint`}
      aria-controls={`${searchId}-results`}
      aria-expanded="false"
      autocomplete="off"
      spellcheck="false"
    />
    <svg
      class="pointer-events-none absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <span id={`${searchId}-hint`} class="sr-only">
      Type at least 2 characters to search. Use arrow keys to navigate results.
    </span>
  </div>

  <!-- Search Results -->
  <div
    id={`${searchId}-results`}
    class="absolute z-50 mt-2 hidden max-h-96 w-full overflow-y-auto rounded-lg border border-slate-700 bg-slate-800 shadow-2xl"
    role="listbox"
    aria-label="Search results"
  >
    <div id={`${searchId}-list`} class="py-2"></div>
    <div
      id={`${searchId}-status`}
      class="sr-only"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>
  </div>
</div>

<script>
  import Fuse from 'fuse.js';
  import { debounce } from '../../utils/function';
  import { withBasePath } from '../../utils/helpers';

  const CACHE_KEY = '__siteSearchIndexCache__';

  async function loadIndex(indexUrl: string) {
    const w = window as unknown as Record<string, any>;
    if (!w[CACHE_KEY]) {
      w[CACHE_KEY] = new Map();
    }

    const cache: Map<string, Promise<any>> = w[CACHE_KEY];
    const cached = cache.get(indexUrl);
    if (cached) return cached;

    const promise = fetch(indexUrl).then(async response => {
      if (!response.ok) {
        throw new Error(`Failed to load search index: ${response.status}`);
      }
      return response.json();
    });

    cache.set(indexUrl, promise);
    return promise;
  }

  declare global {
    interface Window {
      __searchUiBound?: boolean;
    }
  }

  function closeSearchResults(wrapper: HTMLElement): void {
    const input = wrapper.querySelector(
      'input[type="search"]'
    ) as HTMLInputElement | null;
    if (!input) return;

    const searchId = input.id;
    const results = document.getElementById(`${searchId}-results`);
    results?.classList.add('hidden');
    input.setAttribute('aria-expanded', 'false');
  }

  function bindGlobalSearchCloseHandler(): void {
    if (window.__searchUiBound) return;
    window.__searchUiBound = true;

    document.addEventListener(
      'click',
      e => {
        const target = e.target as Node | null;
        if (!target) return;

        document.querySelectorAll('[data-search-wrapper]').forEach(wrapper => {
          if (!(wrapper instanceof HTMLElement)) return;
          if (!wrapper.isConnected) return;
          if (wrapper.contains(target)) return;
          closeSearchResults(wrapper);
        });
      },
      { capture: true }
    );

    // Ensure results never remain open across view transitions.
    document.addEventListener('astro:page-load', () => {
      document.querySelectorAll('[data-search-wrapper]').forEach(wrapper => {
        if (!(wrapper instanceof HTMLElement)) return;
        closeSearchResults(wrapper);
      });
    });
  }

  function initSearch(wrapper: Element) {
    if (!(wrapper instanceof HTMLElement)) return;

    // Avoid duplicate listeners when init runs on both initial load and
    // Astro view transitions.
    if (wrapper.hasAttribute('data-search-initialized')) return;
    wrapper.setAttribute('data-search-initialized', '');

    const indexUrl = wrapper.dataset.indexUrl;
    if (!indexUrl) return;

    const maxResults = parseInt(wrapper.dataset.maxResults || '5', 10);

    const input = wrapper.querySelector(
      'input[type="search"]'
    ) as HTMLInputElement;
    if (!input) return;

    const searchId = input.id;
    const results = document.getElementById(`${searchId}-results`);
    const resultsList = document.getElementById(`${searchId}-list`);
    const searchStatus = document.getElementById(`${searchId}-status`);

    if (!results || !resultsList) return;

    let fuse: any = null;
    let indexReady = false;
    let indexError: string | null = null;

    const ensureIndex = async () => {
      if (indexReady || indexError) return;
      try {
        const items = await loadIndex(indexUrl);
        fuse = new Fuse(items, {
          keys: [
            { name: 'title', weight: 2 },
            { name: 'description', weight: 1 },
            { name: 'tags', weight: 1 },
            { name: 'category', weight: 0.5 },
          ],
          threshold: 0.35,
          includeScore: true,
          minMatchCharLength: 2,
        });
        indexReady = true;
      } catch (err) {
        indexError = err instanceof Error ? err.message : String(err);
      }
    };

    let selectedIndex = -1;

    // Announce results to screen readers
    function announceResults(count: number, query: string) {
      if (searchStatus) {
        if (count === 0) {
          searchStatus.textContent = `No results found for "${query}"`;
        } else {
          searchStatus.textContent = `${count} result${count === 1 ? '' : 's'} found for "${query}"`;
        }
      }
    }

    function performSearch(query: string) {
      if (!query || query.length < 2) {
        results?.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        return;
      }

      if (!indexReady) {
        // kick off index load and show a tiny status for screen readers
        void ensureIndex().then(() => performSearch(query));

        if (resultsList) {
          resultsList.textContent = '';
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'px-4 py-3 text-slate-400 text-sm';
          loadingDiv.setAttribute('role', 'status');
          loadingDiv.textContent = indexError
            ? 'Search is temporarily unavailable.'
            : 'Loading searchâ€¦';
          resultsList.appendChild(loadingDiv);
        }

        results?.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        return;
      }

      const searchResults = fuse.search(query, { limit: maxResults });

      // Clear previous results
      if (resultsList) {
        resultsList.textContent = '';
      }

      if (searchResults.length === 0) {
        if (resultsList) {
          const noResultsDiv = document.createElement('div');
          noResultsDiv.className = 'px-4 py-3 text-slate-400 text-sm';
          noResultsDiv.setAttribute('role', 'status');
          noResultsDiv.textContent = `No results found for "${query}"`;
          resultsList.appendChild(noResultsDiv);
        }
        results?.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        announceResults(0, query);
        return;
      }

      if (resultsList) {
        searchResults.forEach((result: any, index: number) => {
          const link = document.createElement('a');
          link.href = withBasePath(result.item.url || '/');
          link.className = `block px-4 py-3 hover:bg-slate-700 focus:bg-slate-700 focus:outline-none transition-colors ${index === selectedIndex ? 'bg-slate-700' : ''}`;
          link.dataset.resultIndex = index.toString();
          link.setAttribute('role', 'option');
          link.setAttribute(
            'aria-selected',
            (index === selectedIndex).toString()
          );

          const titleDiv = document.createElement('div');
          titleDiv.className = 'font-semibold text-slate-200';
          titleDiv.textContent = result.item.title;
          link.appendChild(titleDiv);

          if (result.item.category) {
            const metaDiv = document.createElement('div');
            metaDiv.className =
              'mt-1 text-[0.7rem] uppercase tracking-widest text-slate-500';
            metaDiv.textContent = result.item.category;
            link.appendChild(metaDiv);
          }

          const descDiv = document.createElement('div');
          descDiv.className = 'text-sm text-slate-400 mt-1 line-clamp-2';
          descDiv.textContent = result.item.description;
          link.appendChild(descDiv);

          resultsList.appendChild(link);
        });
      }

      results?.classList.remove('hidden');
      input.setAttribute('aria-expanded', 'true');
      selectedIndex = -1;
      announceResults(searchResults.length, query);
    }

    // Input handler with debounce
    const handleInput = debounce((...args: unknown[]) => {
      const e = args[0] as Event | undefined;
      const target = (e?.target as HTMLInputElement | null) ?? null;
      performSearch(target?.value || '');
    }, 200);

    input.addEventListener('input', handleInput);

    // Keyboard navigation
    input.addEventListener('keydown', e => {
      if (!resultsList) return;
      const resultItems = resultsList.querySelectorAll('a');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, resultItems.length - 1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        (resultItems[selectedIndex] as HTMLElement)?.click();
      } else if (e.key === 'Escape') {
        results?.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        input.blur();
      }
    });

    function updateSelectedResult(items: NodeListOf<Element>) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('bg-slate-700');
          item.setAttribute('aria-selected', 'true');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('bg-slate-700');
          item.setAttribute('aria-selected', 'false');
        }
      });
    }
  }

  bindGlobalSearchCloseHandler();

  // Initialize on load
  document.querySelectorAll('[data-search-wrapper]').forEach(initSearch);

  // Re-initialize on view transitions (if used)
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('[data-search-wrapper]').forEach(initSearch);
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
