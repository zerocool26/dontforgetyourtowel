---
import { BASE_PATH, CONTACT_EMAIL, SITE_TITLE } from '../consts';
import { withBasePath } from '../utils/helpers';
import ThemeSelector from './ThemeSelector.astro';
import ModernButton from './ui/ModernButton.astro';

const homeHref = withBasePath('/');

const links = [
  { label: 'Services', href: withBasePath('services/') },
  { label: 'Pricing', href: withBasePath('pricing/') },
  { label: 'About', href: withBasePath('about/') },
];

const startProjectHref = `mailto:${encodeURIComponent(
  CONTACT_EMAIL
)}?subject=${encodeURIComponent('New project inquiry')}`;

const normalizePath = (value: string) => {
  const strippedBase =
    BASE_PATH && BASE_PATH !== '/' ? value.replace(BASE_PATH, '/') : value;
  const trimmed = strippedBase.replace(/\/+$/, '');
  return trimmed.length ? trimmed : '/';
};

const currentPath = normalizePath(Astro.url.pathname);

const isActiveHref = (href: string) => {
  try {
    const url = Astro.site
      ? new URL(href, Astro.site)
      : new URL(href, 'https://local.invalid');
    return normalizePath(url.pathname) === currentPath;
  } catch {
    return normalizePath(href) === currentPath;
  }
};
---

<header
  class="safe-area-inset-top sticky top-0 z-50 border-b border-t-4 border-b-zinc-800 border-t-accent-500 bg-zinc-950/95 backdrop-blur-md"
>
  <nav
    class="mx-auto flex h-16 max-w-[1400px] items-center justify-between px-5 py-0 sm:px-6 lg:px-8"
    aria-label="Main navigation"
  >
    <a
      class="group flex h-full items-center gap-3 rounded-md py-3 text-zinc-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-0"
      href={homeHref}
      aria-label={`${SITE_TITLE} home`}
    >
      <span
        class="inline-flex h-8 w-8 items-center justify-center border border-zinc-700 bg-zinc-900 text-[10px] font-bold uppercase tracking-widest text-zinc-100 transition-colors group-hover:border-accent-500 group-hover:text-accent-500"
      >
        OC
      </span>
      <div class="flex flex-col leading-none">
        <span
          class="font-display text-sm font-bold uppercase tracking-tight text-zinc-100"
        >
          {SITE_TITLE}
        </span>
        <span
          class="mt-0.5 font-mono text-[0.6rem] uppercase tracking-widest text-accent-500"
        >
          CONSULTING • SECURITY • CLOUD • ENGINEERING
        </span>
      </div>
    </a>

    <div class="hidden h-full items-center md:flex">
      {
        (() => {
          const active = isActiveHref(homeHref);
          return (
            <a
              class={`flex h-full items-center border-l border-zinc-800/50 px-4 font-mono text-xs uppercase tracking-wide transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-0 ${
                active
                  ? 'bg-zinc-900 text-white'
                  : 'text-zinc-400 hover:bg-zinc-900 hover:text-white'
              }`}
              href={homeHref}
              aria-current={active ? 'page' : undefined}
            >
              Home
            </a>
          );
        })()
      }
      {
        links.map(link => {
          const active = isActiveHref(link.href);
          return (
            <a
              class={`flex h-full items-center border-l border-zinc-800/50 px-4 font-mono text-xs uppercase tracking-wide transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 focus-visible:ring-offset-0 ${
                active
                  ? 'bg-zinc-900 text-white'
                  : 'text-zinc-400 hover:bg-zinc-900 hover:text-white'
              }`}
              href={link.href}
              aria-current={active ? 'page' : undefined}
            >
              {link.label}
            </a>
          );
        })
      }
      <div class="h-full w-px bg-zinc-800/50"></div>
    </div>

    <div class="hidden items-center gap-4 pl-6 md:flex">
      <ThemeSelector />
      <div class="h-6 w-px bg-zinc-800"></div>
      <ModernButton
        variant="primary"
        className="font-mono text-xs uppercase tracking-wider"
        rounded="sm"
        href={startProjectHref}
      >
        Start a Project
      </ModernButton>
    </div>

    <div class="md:hidden">
      <ModernButton
        variant="outline"
        className="min-h-touch min-w-touch flex h-12 w-12 touch-manipulation items-center justify-center border-zinc-800 bg-zinc-900 p-0 text-zinc-400 hover:border-zinc-600 hover:text-white"
        id="mobile-menu-button"
        type="button"
        aria-controls="mobile-menu"
        aria-expanded="false"
        rounded="none"
      >
        <span class="sr-only">Toggle navigation</span>
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M4 7h16M4 12h16M4 17h16"
            stroke-linecap="square"
            stroke-linejoin="miter"
            stroke-width="1.5"></path>
        </svg>
      </ModernButton>
    </div>
  </nav>

  <div class="md:hidden" id="mobile-menu" hidden>
    <div
      class="space-y-2 border-t border-white/10 bg-[rgba(11,19,35,0.92)] px-4 py-5 text-sm"
    >
      <a
        class="min-h-touch flex touch-manipulation items-center rounded-lg px-3 py-3 font-medium text-slate-200 transition hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400"
        href={homeHref}
        aria-current={isActiveHref(homeHref) ? 'page' : undefined}
      >
        Home
      </a>
      {
        links.map(link => {
          const active = isActiveHref(link.href);
          return (
            <a
              class={`min-h-touch flex touch-manipulation items-center rounded-lg px-3 py-3 font-medium transition hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400 ${
                active ? 'bg-white/10 text-white' : 'text-slate-200'
              }`}
              href={link.href}
              aria-current={active ? 'page' : undefined}
            >
              {link.label}
            </a>
          );
        })
      }
      <a
        class="min-h-touch flex touch-manipulation items-center rounded-lg px-3 py-3 font-semibold text-slate-100 transition hover:bg-white/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400"
        href={withBasePath('services/')}
      >
        View services
      </a>
      <a
        class="min-h-touch flex touch-manipulation items-center rounded-lg bg-[rgba(99,102,241,0.15)] px-3 py-3 font-semibold text-white transition hover:bg-[rgba(99,102,241,0.25)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent-400"
        href={startProjectHref}
      >
        Start a project
      </a>
    </div>
  </div>
</header>

<script>
  // Import the enhanced header script that uses our utilities
  import '../scripts/header';
</script>
