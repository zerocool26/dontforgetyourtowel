---
import Hero3DCore from '../ui/hero3d/Hero3DCore.astro';
import Hero3DOrbits from '../ui/hero3d/Hero3DOrbits.astro';

const scenes = [
  {
    id: 'signal',
    label: 'Signal Horizon',
    desc: 'Cinematic beams, orbitals, and data wakes that react to scroll velocity.',
    accent: '99 102 241',
    glow: '14 165 233',
    chips: ['Orbital flux', 'Wavefield drift', 'Phase glow'],
  },
  {
    id: 'aurora',
    label: 'Aurora Core',
    desc: 'Chromatic nebula sweeps with prismatic energy rings.',
    accent: '168 85 247',
    glow: '236 72 153',
    chips: ['Prism rays', 'Nebula fade', 'Lens bloom'],
  },
  {
    id: 'matrix',
    label: 'Matrix Drift',
    desc: 'Falling glyphs and depth stacks for retro-future motion.',
    accent: '34 211 238',
    glow: '59 130 246',
    chips: ['Glyph rain', 'Grid dive', 'Vector noise'],
  },
  {
    id: 'vortex',
    label: 'Vortex Array',
    desc: 'Spiral particle corridors and kinetic pulse walls.',
    accent: '251 146 60',
    glow: '248 113 113',
    chips: ['Spiral warp', 'Pulse belts', 'Dust trails'],
  },
];

const particles = Array.from({ length: 42 }).map((_, i) => {
  const x = Math.round(Math.random() * 90 + 5);
  const y = Math.round(Math.random() * 70 + 15);
  const delay = (i % 12) * 0.18;
  const size = 2 + (i % 3);
  return { x, y, delay, size };
});
---

<section class="immersive" data-immersive data-immersive-active="signal">
  <div class="immersive-stage" aria-hidden="true">
    <div class="immersive-scene">
      <div class="scene-layer layer-stars"></div>
      <div class="scene-layer layer-aurora"></div>
      <div class="scene-layer layer-grid"></div>
      <div class="scene-layer layer-halo"></div>
      <div class="scene-layer layer-matrix"></div>
      <div class="scene-layer layer-vortex"></div>
      <div class="scene-layer layer-spark"></div>
      <Hero3DOrbits className="scene-layer layer-orbits" animate={false} />
      <Hero3DCore className="scene-layer layer-core" animate={false} />
      <div class="scene-layer layer-streams">
        <div class="scene-layer layer-tunnel"></div>
        <div class="scene-layer layer-glitch"></div>
        <div class="scene-layer layer-wave"></div>
        <div class="scene-layer layer-constellation"></div>
        {
          Array.from({ length: 12 }).map((_, i) => (
            <span class="stream" style={`--i:${i}`} />
          ))
        }
      </div>
      <div class="scene-layer layer-particles">
        {
          particles.map(p => (
            <span
              class="particle"
              style={`--x:${p.x};--y:${p.y};--delay:${p.delay}s;--size:${p.size}px`}
            />
          ))
        }
      </div>
      <div class="scene-layer layer-flares"></div>
    </div>
  </div>

  <div class="immersive-track">
    <section
      class="immersive-panel is-hero"
      data-panel
      data-scene="signal"
      style="--accent: 99 102 241; --glow: 14 165 233"
    >
      <div class="panel-content">
        <p class="immersive-kicker">Immersive 3D Lab</p>
        <h1 class="immersive-title">
          <span
            class="depth-text"
            data-text="Fullscreen scroll, cinematic depth, endless ideas."
          >
            <span class="depth-text__inner">
              Fullscreen scroll, cinematic depth, endless ideas.
            </span>
          </span>
        </h1>
        <p class="immersive-subtitle">
          A real multi‑scene scroll experience that keeps the 3D stage locked
          while content and motion evolve. WebGPU‑ready, modular, and built for
          every screen.
        </p>
        <div class="panel-metrics">
          <span>Scroll-reactive motion</span>
          <span>Adaptive performance</span>
          <span>Modular scenes</span>
        </div>
        <div class="scroll-hint">Scroll to explore ↓</div>
      </div>
      <div class="panel-visual hero-visual" aria-hidden="true">
        <span class="panel-orb"></span>
        <span class="panel-orb orb-2"></span>
        <span class="panel-grid"></span>
        <span class="panel-lines"></span>
      </div>
    </section>

    {
      scenes.map(scene => (
        <section
          class="immersive-panel"
          data-panel
          data-scene={scene.id}
          style={`--accent:${scene.accent};--glow:${scene.glow}`}
        >
          <div class="panel-content">
            <p class="panel-tag">Scene {scene.label}</p>
            <h2>
              <span class="depth-text" data-text={scene.label}>
                <span class="depth-text__inner">{scene.label}</span>
              </span>
            </h2>
            <p>{scene.desc}</p>
            <div class="panel-chips">
              {scene.chips.map(chip => (
                <span class="chip">{chip}</span>
              ))}
            </div>
          </div>
          <div class="panel-visual" aria-hidden="true">
            <span class="panel-orb" />
            <span class="panel-orb orb-2" />
            <span class="panel-grid" />
            <span class="panel-lines" />
          </div>
        </section>
      ))
    }
  </div>

  <div class="scroll-rail" aria-hidden="true">
    <span class="scroll-thumb"></span>
  </div>
</section>

<style>
  .immersive {
    position: relative;
    min-height: 100vh;
    background: radial-gradient(circle at top, #0b1120, #020617 65%);
    color: #e2e8f0;
    overflow: hidden;
    --active-accent: 99 102 241;
    --active-glow: 14 165 233;
  }

  .immersive::before {
    content: '';
    position: absolute;
    inset: -10% -5% 40%;
    background: radial-gradient(
      circle at top,
      rgba(var(--active-accent), 0.2),
      transparent 70%
    );
    opacity: 0.7;
    pointer-events: none;
    transition: opacity 600ms ease;
  }

  .immersive::after {
    content: '';
    position: absolute;
    inset: 40% -10% -10%;
    background: radial-gradient(
      circle at 40% 20%,
      rgba(var(--active-glow), 0.18),
      transparent 70%
    );
    opacity: 0.65;
    pointer-events: none;
    transition: opacity 600ms ease;
  }

  .immersive-kicker {
    font-size: 0.7rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(148, 163, 184, 0.7);
    margin-bottom: 1rem;
  }

  .immersive-title {
    font-size: clamp(2.5rem, 7vw, 5rem);
    line-height: 1.05;
    font-weight: 800;
    color: #f8fafc;
    margin-bottom: 1.5rem;
  }

  .immersive-subtitle {
    font-size: clamp(1rem, 2.4vw, 1.3rem);
    color: rgba(226, 232, 240, 0.75);
  }

  .immersive-stage {
    position: sticky;
    top: 0;
    height: 100vh;
    pointer-events: none;
    display: grid;
    place-items: center;
    z-index: 1;
  }

  .scroll-rail {
    position: fixed;
    right: clamp(0.75rem, 2vw, 2rem);
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: min(320px, 40vh);
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.15);
    z-index: 6;
    overflow: hidden;
  }

  .scroll-thumb {
    display: block;
    width: 100%;
    height: 30%;
    border-radius: inherit;
    background: linear-gradient(
      180deg,
      rgba(var(--active-accent), 0.8),
      rgba(var(--active-glow), 0.7)
    );
    transform: translateY(calc(var(--scroll-progress, 0) * 70%));
    transition: transform 200ms ease;
  }

  .immersive-scene {
    position: relative;
    width: min(960px, 90vw);
    aspect-ratio: 1;
    transform-style: preserve-3d;
    perspective: 1400px;
    animation: sceneFloat 18s ease-in-out infinite;
    transform: translateY(calc(var(--scroll-progress, 0) * -24px))
      rotateX(calc(var(--scroll-progress, 0) * 4deg))
      rotateZ(calc(var(--scroll-progress, 0) * -3deg))
      rotateY(calc(var(--scene-shift, 0) * 0.06deg));
    filter: drop-shadow(0 0 60px rgba(var(--active-accent), 0.3));
  }

  .scene-layer {
    position: absolute;
    inset: 0;
    transform-style: preserve-3d;
  }

  .layer-stars {
    background-image:
      radial-gradient(rgba(255, 255, 255, 0.35) 1px, transparent 1px),
      radial-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px);
    background-size:
      80px 80px,
      140px 140px;
    opacity: 0.45;
    transform: translateZ(-380px);
    animation: starsDrift 22s ease-in-out infinite;
  }

  .layer-aurora {
    background: linear-gradient(
      120deg,
      rgba(var(--active-glow), 0.25),
      rgba(var(--active-accent), 0.25),
      rgba(236, 72, 153, 0.25),
      transparent 70%
    );
    background-size: 200% 200%;
    mix-blend-mode: screen;
    transform: translateZ(-240px);
    opacity: 0.65;
    animation: auroraSweep 16s ease-in-out infinite;
  }

  .layer-grid {
    inset: 8% 10% 40%;
    background-image:
      linear-gradient(rgba(148, 163, 184, 0.25) 1px, transparent 1px),
      linear-gradient(90deg, rgba(148, 163, 184, 0.25) 1px, transparent 1px);
    background-size: 50px 50px;
    transform: translateZ(-120px) rotateX(70deg);
    opacity: 0.4;
  }

  .layer-halo {
    inset: 12% 16% 24%;
    border-radius: 50%;
    border: 1px solid rgba(var(--active-accent), 0.25);
    box-shadow:
      0 0 120px rgba(var(--active-accent), 0.25),
      inset 0 0 60px rgba(var(--active-glow), 0.2);
    opacity: 0.25;
    transform: translateZ(-60px);
    animation: haloBreath 14s ease-in-out infinite;
  }

  .layer-matrix {
    inset: 12% 12% 18%;
    background:
      repeating-linear-gradient(
        180deg,
        rgba(56, 189, 248, 0.16) 0,
        rgba(56, 189, 248, 0.16) 2px,
        transparent 2px,
        transparent 14px
      ),
      repeating-linear-gradient(
        90deg,
        rgba(34, 211, 238, 0.12) 0,
        rgba(34, 211, 238, 0.12) 1px,
        transparent 1px,
        transparent 18px
      );
    opacity: 0;
    transform: translateZ(-80px) translateY(-8%);
    animation: matrixRain 12s linear infinite;
  }

  .layer-vortex {
    inset: 8% 8% 8%;
    border-radius: 50%;
    background: conic-gradient(
      from 90deg,
      rgba(var(--active-accent), 0.25),
      transparent,
      rgba(var(--active-glow), 0.25),
      transparent
    );
    opacity: 0;
    transform: translateZ(40px) rotate(0deg);
    animation: vortexSpin 16s linear infinite;
    mask: radial-gradient(circle, transparent 45%, #000 55%);
  }

  .layer-spark {
    inset: 20% 18% 26%;
    border-radius: 30%;
    background: radial-gradient(
      circle at 30% 30%,
      rgba(var(--active-glow), 0.35),
      transparent 60%
    );
    opacity: 0.15;
    transform: translateZ(120px);
    animation: sparkPulse 6s ease-in-out infinite;
  }

  .layer-tunnel {
    inset: 6% 6% 6%;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      transparent 40%,
      rgba(var(--active-accent), 0.25) 55%,
      transparent 70%
    );
    opacity: 0;
    transform: translateZ(-120px) scale(0.9);
    animation: tunnelPulse 16s ease-in-out infinite;
  }

  .layer-glitch {
    inset: 12% 14% 18%;
    background:
      repeating-linear-gradient(
        120deg,
        rgba(var(--active-glow), 0.15) 0,
        rgba(var(--active-glow), 0.15) 2px,
        transparent 2px,
        transparent 14px
      ),
      repeating-linear-gradient(
        0deg,
        rgba(255, 255, 255, 0.08) 0,
        rgba(255, 255, 255, 0.08) 1px,
        transparent 1px,
        transparent 12px
      );
    mix-blend-mode: screen;
    opacity: 0;
    transform: translateZ(20px);
    animation: glitchFlicker 6s steps(2, end) infinite;
  }

  .layer-wave {
    inset: 8% 10% 22%;
    background: radial-gradient(
      circle at 20% 30%,
      rgba(var(--active-glow), 0.25),
      transparent 55%
    );
    opacity: 0;
    transform: translateZ(-40px);
    animation: waveShift 12s ease-in-out infinite;
  }

  .layer-constellation {
    inset: 0;
    background-image:
      radial-gradient(rgba(255, 255, 255, 0.4) 1px, transparent 1px),
      radial-gradient(rgba(var(--active-glow), 0.35) 1px, transparent 1px);
    background-size:
      120px 120px,
      220px 220px;
    background-position:
      30% 20%,
      70% 60%;
    opacity: 0;
    transform: translateZ(-260px);
    animation: constellationDrift 18s ease-in-out infinite;
  }

  .immersive[data-immersive-active='matrix'] .layer-matrix {
    opacity: 0.6;
  }

  .immersive[data-immersive-active='matrix'] .layer-glitch {
    opacity: 0.5;
  }

  .immersive[data-immersive-active='vortex'] .layer-vortex {
    opacity: 0.5;
  }

  .immersive[data-immersive-active='vortex'] .layer-tunnel {
    opacity: 0.45;
  }

  .immersive[data-immersive-active='signal'] .layer-wave {
    opacity: 0.35;
  }

  .immersive[data-immersive-active='aurora'] .layer-wave {
    opacity: 0.45;
  }

  .immersive[data-immersive-active='aurora'] .layer-tunnel,
  .immersive[data-immersive-active='signal'] .layer-constellation {
    opacity: 0.3;
  }

  .immersive[data-immersive-active='signal'] .layer-spark,
  .immersive[data-immersive-active='aurora'] .layer-spark {
    opacity: 0.35;
  }

  .layer-orbits .orbit {
    position: absolute;
    inset: 18% 18%;
    border-radius: 50%;
    border: 1px solid rgba(148, 163, 184, 0.45);
    box-shadow: 0 0 24px rgba(var(--active-accent), 0.35);
    animation: orbitSpin calc(18s - (var(--scroll-velocity, 0) * 4s)) linear
      infinite;
  }

  .orbit-2 {
    inset: 28% 28%;
    transform: rotateX(70deg);
    animation-duration: 24s;
  }

  .orbit-3 {
    inset: 12% 12%;
    transform: rotateY(75deg);
    animation-duration: 28s;
  }

  .layer-core {
    display: grid;
    place-items: center;
    transform: translateZ(120px);
  }

  .core-shell {
    width: min(280px, 50vw);
    aspect-ratio: 1;
    border-radius: 30% 70% 60% 40%;
    background: linear-gradient(
      135deg,
      rgba(var(--active-accent), 0.35),
      rgba(var(--active-glow), 0.25)
    );
    box-shadow:
      0 0 80px rgba(var(--active-accent), 0.45),
      0 0 140px rgba(var(--active-glow), 0.35);
    animation: corePulse 6s ease-in-out infinite;
  }

  .core-glow {
    position: absolute;
    width: min(140px, 24vw);
    aspect-ratio: 1;
    border-radius: 999px;
    background: radial-gradient(
      circle,
      rgba(255, 255, 255, 0.7),
      rgba(var(--active-glow), 0.1)
    );
    opacity: 0.5;
    animation: glowSpin 8s linear infinite;
  }

  .core-ring {
    position: absolute;
    width: min(220px, 40vw);
    aspect-ratio: 1;
    border-radius: 50%;
    border: 1px dashed rgba(226, 232, 240, 0.45);
    animation: ringSpin 12s linear infinite;
  }

  .layer-streams .stream {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 2px;
    height: 180px;
    background: linear-gradient(
      to bottom,
      transparent,
      rgba(var(--active-glow), 0.8),
      transparent
    );
    transform-origin: top;
    transform: translate(-50%, -50%) rotate(calc(var(--i) * 30deg));
    animation: streamPulse calc(4s - (var(--scroll-velocity, 0) * 1.5s))
      ease-in-out infinite;
    animation-delay: calc(var(--i) * 0.2s);
  }

  .layer-flares {
    inset: 10% 12% 18%;
    border-radius: 40%;
    border: 1px solid rgba(var(--active-accent), 0.2);
    box-shadow:
      0 0 120px rgba(var(--active-accent), 0.25),
      0 0 200px rgba(var(--active-glow), 0.2);
    opacity: 0.45;
    animation: flarePulse 12s ease-in-out infinite;
  }

  .immersive-track {
    position: relative;
    z-index: 4;
  }

  .immersive-panel {
    min-height: 100vh;
    display: grid;
    place-items: center;
    padding: clamp(4rem, 8vw, 7rem) clamp(1.5rem, 6vw, 6rem);
    border-top: 1px solid rgba(148, 163, 184, 0.12);
    position: relative;
    perspective: 1400px;
    transform-style: preserve-3d;
  }

  .immersive-panel::before {
    content: '';
    position: absolute;
    inset: 12% 8% 18%;
    border-radius: 32px;
    background: radial-gradient(
      circle at top,
      rgba(var(--accent), 0.18),
      transparent 70%
    );
    opacity: 0.7;
    pointer-events: none;
  }

  .immersive-panel::after {
    content: '';
    position: absolute;
    inset: 20% 18% 10%;
    border-radius: 28px;
    border: 1px solid rgba(var(--accent), 0.25);
    opacity: 0.25;
    pointer-events: none;
  }

  .panel-content {
    max-width: 680px;
    background: linear-gradient(
      135deg,
      rgba(2, 6, 23, 0.55),
      rgba(15, 23, 42, 0.35)
    );
    border: 1px solid rgba(var(--accent), 0.25);
    border-radius: 28px;
    padding: clamp(2rem, 4vw, 3rem);
    box-shadow: 0 24px 60px rgba(2, 6, 23, 0.5);
    backdrop-filter: blur(14px);
    position: relative;
    z-index: 2;
    transition:
      transform 400ms ease,
      box-shadow 400ms ease;
    transform: translateZ(calc(var(--panel-depth, 0) * 1px))
      rotateX(calc(var(--panel-tilt, 0) * 1deg));
    transform-style: preserve-3d;
  }

  .depth-text {
    position: relative;
    display: inline-block;
    transform-style: preserve-3d;
  }

  .depth-text::before,
  .depth-text::after {
    content: attr(data-text);
    position: absolute;
    inset: 0;
    color: rgba(var(--accent), 0.25);
    opacity: 0.6;
    transform: translateZ(-20px) translate(2px, 2px);
    text-shadow: 0 0 12px rgba(var(--accent), 0.35);
    pointer-events: none;
  }

  .depth-text::after {
    color: rgba(var(--glow), 0.2);
    transform: translateZ(-40px) translate(-2px, -2px);
    opacity: 0.4;
  }

  .depth-text__inner {
    position: relative;
    z-index: 2;
    transform: translateZ(calc(var(--panel-depth, 0) * 0.4px));
  }

  .panel-content::before {
    content: '';
    position: absolute;
    inset: 6% 6% 70%;
    border-radius: 20px;
    background: radial-gradient(
      circle,
      rgba(var(--accent), 0.25),
      transparent 70%
    );
    opacity: 0.8;
    pointer-events: none;
  }

  .panel-tag {
    font-size: 0.7rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(148, 163, 184, 0.65);
    margin-bottom: 0.8rem;
  }

  .panel-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .chip {
    padding: 0.4rem 0.75rem;
    border-radius: 999px;
    border: 1px solid rgba(var(--accent), 0.35);
    color: rgba(226, 232, 240, 0.85);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

  .panel-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
    color: rgba(226, 232, 240, 0.7);
    font-size: 0.85rem;
  }

  .scroll-hint {
    margin-top: 2rem;
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(148, 163, 184, 0.7);
  }

  .panel-visual {
    position: absolute;
    inset: 15% 12% 18%;
    border-radius: 32px;
    opacity: 0.35;
    pointer-events: none;
    z-index: 1;
  }

  .panel-visual .panel-orb {
    position: absolute;
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(var(--accent), 0.35),
      transparent 70%
    );
    top: 15%;
    right: 10%;
    filter: blur(8px);
  }

  .panel-visual .orb-2 {
    width: 240px;
    height: 240px;
    top: 45%;
    left: 10%;
    opacity: 0.6;
  }

  .panel-visual .panel-grid {
    position: absolute;
    inset: 12% 18% 30%;
    background-image:
      linear-gradient(rgba(var(--accent), 0.2) 1px, transparent 1px),
      linear-gradient(90deg, rgba(var(--accent), 0.2) 1px, transparent 1px);
    background-size: 40px 40px;
    transform: rotateX(65deg);
    opacity: 0.4;
  }

  .panel-visual .panel-lines {
    position: absolute;
    inset: 35% 12% 12%;
    border: 1px dashed rgba(var(--accent), 0.35);
    border-radius: 24px;
  }

  .immersive-panel.is-active .panel-content {
    transform: translateY(-8px) scale(1.01);
    box-shadow:
      0 28px 70px rgba(2, 6, 23, 0.6),
      0 0 40px rgba(var(--accent), 0.2);
  }

  .immersive-panel.is-active .panel-content h2,
  .immersive-panel.is-active .panel-content h1 {
    text-shadow:
      0 0 20px rgba(var(--accent), 0.35),
      0 0 60px rgba(var(--accent), 0.2);
  }

  .is-hero .panel-content {
    background: rgba(15, 23, 42, 0.7);
  }

  .layer-particles .particle {
    position: absolute;
    width: var(--size, 4px);
    height: var(--size, 4px);
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.8);
    left: calc(var(--x) * 1%);
    top: calc(var(--y) * 1%);
    opacity: 0.6;
    animation: particleFloat 8s ease-in-out infinite;
    animation-delay: var(--delay, 0s);
  }

  .immersive-panel h2 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin-bottom: 0.8rem;
  }

  .immersive-panel p {
    color: rgba(226, 232, 240, 0.75);
  }

  @keyframes sceneFloat {
    0%,
    100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-12px) scale(1.02);
    }
  }

  @keyframes starsDrift {
    0%,
    100% {
      opacity: 0.3;
      transform: translateZ(-380px) translateY(0);
    }
    50% {
      opacity: 0.6;
      transform: translateZ(-380px) translateY(12px);
    }
  }

  @keyframes auroraSweep {
    0%,
    100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }

  @keyframes orbitSpin {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes corePulse {
    0%,
    100% {
      transform: scale(0.96);
    }
    50% {
      transform: scale(1.05);
    }
  }

  @keyframes glowSpin {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes ringSpin {
    to {
      transform: rotate(-360deg);
    }
  }

  @keyframes streamPulse {
    0%,
    100% {
      opacity: 0.3;
    }
    50% {
      opacity: 0.8;
    }
  }

  @keyframes particleFloat {
    0%,
    100% {
      transform: translateY(0);
      opacity: 0.4;
    }
    50% {
      transform: translateY(-12px);
      opacity: 0.9;
    }
  }

  @keyframes matrixRain {
    0% {
      background-position:
        0 0,
        0 0;
      opacity: 0.15;
    }
    100% {
      background-position:
        0 120px,
        0 60px;
      opacity: 0.45;
    }
  }

  @keyframes vortexSpin {
    to {
      transform: translateZ(40px) rotate(360deg);
    }
  }

  @keyframes sparkPulse {
    0%,
    100% {
      opacity: 0.2;
      transform: translateZ(120px) scale(0.96);
    }
    50% {
      opacity: 0.6;
      transform: translateZ(120px) scale(1.05);
    }
  }

  @keyframes haloBreath {
    0%,
    100% {
      opacity: 0.2;
      transform: translateZ(-60px) scale(0.96);
    }
    50% {
      opacity: 0.45;
      transform: translateZ(-60px) scale(1.04);
    }
  }

  @keyframes flarePulse {
    0%,
    100% {
      opacity: 0.25;
      transform: scale(0.98);
    }
    50% {
      opacity: 0.55;
      transform: scale(1.03);
    }
  }

  @keyframes tunnelPulse {
    0%,
    100% {
      opacity: 0.15;
      transform: translateZ(-120px) scale(0.92);
    }
    50% {
      opacity: 0.5;
      transform: translateZ(-120px) scale(1.02);
    }
  }

  @keyframes glitchFlicker {
    0%,
    100% {
      opacity: 0.1;
      transform: translateZ(20px) translateX(0);
    }
    50% {
      opacity: 0.6;
      transform: translateZ(20px) translateX(8px);
    }
  }

  @keyframes waveShift {
    0%,
    100% {
      transform: translateZ(-40px) translateY(0);
      opacity: 0.2;
    }
    50% {
      transform: translateZ(-40px) translateY(-12px);
      opacity: 0.6;
    }
  }

  @keyframes constellationDrift {
    0%,
    100% {
      background-position:
        30% 20%,
        70% 60%;
      opacity: 0.2;
    }
    50% {
      background-position:
        40% 30%,
        60% 50%;
      opacity: 0.5;
    }
  }

  @media (max-width: 900px) {
    .immersive-scene {
      width: min(520px, 90vw);
    }

    .layer-streams .stream {
      height: 140px;
    }
  }

  @media (pointer: coarse) {
    .immersive-stage {
      position: sticky;
      height: 80vh;
    }

    .immersive-scene {
      animation: none;
    }

    .layer-streams,
    .layer-particles {
      display: none;
    }

    .scroll-rail {
      display: none;
    }
  }

  @media (max-width: 720px) {
    .immersive-panel {
      padding: 4rem 1.5rem;
    }

    .panel-content {
      padding: 1.75rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .immersive * {
      animation: none !important;
      transition: none !important;
    }

    .scroll-thumb {
      transform: translateY(calc(var(--scroll-progress, 0) * 70%));
    }
  }
</style>

<script>
  const root = document.querySelector('[data-immersive]');
  if (root instanceof HTMLElement) {
    const rootEl = root;
    const panels = Array.from(
      rootEl.querySelectorAll<HTMLElement>('[data-panel]')
    ) as HTMLElement[];
    let lastScroll = window.scrollY;
    let lastTime = performance.now();
    let ticking = false;

    const updateActivePanel = () => {
      const viewportCenter = window.innerHeight * 0.5;
      let closestPanel = panels[0];
      let closestDistance = Number.POSITIVE_INFINITY;

      panels.forEach(panel => {
        const rect = panel.getBoundingClientRect();
        const distance = Math.abs(
          rect.top + rect.height * 0.5 - viewportCenter
        );
        if (distance < closestDistance) {
          closestDistance = distance;
          closestPanel = panel;
        }

        const maxDistance = window.innerHeight * 0.8;
        const normalized = Math.min(1, distance / maxDistance);
        const depth = Math.round((1 - normalized) * 80);
        const tilt =
          ((viewportCenter - (rect.top + rect.height * 0.5)) / viewportCenter) *
          6;
        panel.style.setProperty('--panel-depth', String(depth));
        panel.style.setProperty('--panel-tilt', tilt.toFixed(2));
      });

      panels.forEach(panel => {
        panel.classList.toggle('is-active', panel === closestPanel);
      });

      const scene = closestPanel?.dataset.scene;
      if (scene) rootEl.dataset.immersiveActive = scene;

      if (closestPanel) {
        const styles = getComputedStyle(closestPanel);
        const accent = styles.getPropertyValue('--accent').trim();
        const glow = styles.getPropertyValue('--glow').trim();
        if (accent) rootEl.style.setProperty('--active-accent', accent);
        if (glow) rootEl.style.setProperty('--active-glow', glow);
      }
    };

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const rect = rootEl.getBoundingClientRect();
        const total = rect.height - window.innerHeight;
        const progress =
          total > 0 ? Math.min(1, Math.max(0, -rect.top / total)) : 0;
        const now = performance.now();
        const delta = Math.abs(window.scrollY - lastScroll);
        const time = Math.max(16, now - lastTime);
        const velocity = Math.min(1, delta / time);
        rootEl.style.setProperty('--scroll-progress', progress.toFixed(3));
        rootEl.style.setProperty('--scroll-velocity', velocity.toFixed(3));
        rootEl.style.setProperty('--scene-shift', (progress * 100).toFixed(2));
        updateActivePanel();
        lastScroll = window.scrollY;
        lastTime = now;
        ticking = false;
      });
    };

    onScroll();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onScroll);
  }
</script>
