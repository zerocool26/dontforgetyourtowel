---
const chapters = [
  { id: 'ignite' },
  { id: 'prism' },
  { id: 'swarm' },
  { id: 'rift' },
  { id: 'singularity' },
  { id: 'afterglow' },
];

function mulberry32(seed: number) {
  return function () {
    let t = (seed += 0x6d2b79f5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

const rnd = mulberry32(907198);
const r = (min: number, max: number) => min + (max - min) * rnd();
const ri = (min: number, max: number) => Math.round(r(min, max));

const ribbons = Array.from({ length: 18 }).map((_, i) => ({
  i,
  x: ri(-40, 40),
  y: ri(-30, 30),
  z: ri(-520, 520),
  rx: ri(-40, 40),
  ry: ri(0, 360),
  w: ri(3, 10),
  a: r(0.18, 0.6).toFixed(3),
  h: ri(180, 320),
}));

const prisms = Array.from({ length: 28 }).map((_, i) => ({
  i,
  x: ri(-45, 45),
  y: ri(-38, 38),
  z: ri(-820, 820),
  rx: ri(0, 360),
  ry: ri(0, 360),
  rz: ri(0, 360),
  s: r(0.5, 1.7).toFixed(3),
  a: r(0.12, 0.5).toFixed(3),
  h: ri(190, 340),
}));

const shards = Array.from({ length: 22 }).map((_, i) => ({
  i,
  x: ri(-44, 44),
  y: ri(-36, 36),
  z: ri(-900, 900),
  rx: ri(0, 360),
  ry: ri(0, 360),
  rz: ri(0, 360),
  s: r(0.4, 1.5).toFixed(3),
  a: r(0.08, 0.28).toFixed(3),
  h: ri(210, 360),
}));
---

<section
  class="ih"
  data-ih=""
  data-ih-scene="ignite"
  style={`--ih-chapters:${chapters.length}`}
>
  <div class="ih-stage" aria-hidden="true">
    <canvas class="ih-canvas" data-ih-canvas></canvas>

    <div class="ih-space">
      <div class="ih-layer ih-stars"></div>
      <div class="ih-layer ih-fog"></div>
      <div class="ih-layer ih-portal"></div>

      <div class="ih-layer ih-ribbons">
        {
          ribbons.map(rib => (
            <span
              class="ih-ribbon"
              style={`--i:${rib.i};--x:${rib.x};--y:${rib.y};--z:${rib.z};--rx:${rib.rx};--ry:${rib.ry};--w:${rib.w};--a:${rib.a};--h:${rib.h}`}
            />
          ))
        }
      </div>

      <div class="ih-layer ih-prisms">
        {
          prisms.map(p => (
            <span
              class="ih-prism"
              style={`--i:${p.i};--x:${p.x};--y:${p.y};--z:${p.z};--rx:${p.rx};--ry:${p.ry};--rz:${p.rz};--s:${p.s};--a:${p.a};--h:${p.h}`}
            />
          ))
        }
      </div>

      <div class="ih-layer ih-shards">
        {
          shards.map(s => (
            <span
              class="ih-shard"
              style={`--i:${s.i};--x:${s.x};--y:${s.y};--z:${s.z};--rx:${s.rx};--ry:${s.ry};--rz:${s.rz};--s:${s.s};--a:${s.a};--h:${s.h}`}
            />
          ))
        }
      </div>

      <!-- Pure cinematic mode: no on-screen HUD -->
    </div>
  </div>

  <div class="ih-track" aria-hidden="true">
    {
      chapters.map(ch => (
        <section class="ih-chapter" data-ih-chapter="" data-scene={ch.id} />
      ))
    }
  </div>

  <div class="sr-only" aria-live="polite">Immersive home experience.</div>
</section>

<style>
  .ih {
    position: relative;
    min-height: calc(var(--ih-chapters, 6) * 110vh);
    background: radial-gradient(circle at 50% 20%, #111827, #020617 55%);
    overflow: clip;
    isolation: isolate;

    /* driven by script */
    --ih-scroll: 0;
    --ih-local: 0;
    --ih-vel: 0;
    --ih-parallax-x: 0;
    --ih-parallax-y: 0;
    --ih-burst: 0;
    --ih-event: 0;
    --ih-pinch: 0;
    --ih-quality: 1;
  }

  .ih-stage {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
  }

  /* Cinematic pulse/shockwave, driven by --ih-burst */
  .ih-stage::after {
    content: '';
    position: absolute;
    inset: -20%;
    pointer-events: none;
    opacity: calc(0.04 + (var(--ih-burst) * 0.22) + (var(--ih-event) * 0.16));
    background: radial-gradient(
      circle at 50% 50%,
      rgba(255, 255, 255, 0.15),
      rgba(56, 189, 248, 0.16) 22%,
      rgba(99, 102, 241, 0.12) 40%,
      rgba(236, 72, 153, 0.08) 60%,
      rgba(2, 6, 23, 0) 72%
    );
    transform: scale(
      calc(0.92 + (var(--ih-burst) * 0.22) + (var(--ih-event) * 0.08))
    );
    filter: blur(
      calc(10px + (var(--ih-burst) * 18px) + (var(--ih-event) * 10px))
    );
    mix-blend-mode: screen;
    transition: opacity 200ms ease;
  }

  /* Subtle scanline/glint pass during chapter flips (purely visual) */
  .ih-stage::before {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: calc(var(--ih-event) * 0.22);
    background:
      repeating-linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.08) 0px,
        rgba(255, 255, 255, 0) 2px,
        rgba(255, 255, 255, 0) 10px
      ),
      radial-gradient(
        120% 90% at 50% 40%,
        rgba(56, 189, 248, 0.14),
        rgba(2, 6, 23, 0) 58%
      );
    mix-blend-mode: screen;
    filter: blur(0.2px) saturate(1.2);
    transform: translateZ(0);
  }

  .ih-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0.95;
    mix-blend-mode: screen;
    filter: saturate(calc(1.05 + (var(--ih-burst) * 0.22)))
      contrast(calc(1.05 + (var(--ih-burst) * 0.16)))
      brightness(calc(1 + (var(--ih-event) * 0.08)))
      blur(calc((1 - var(--ih-quality)) * 0.9px));
  }

  .ih-space {
    position: absolute;
    inset: 0;
    transform-style: preserve-3d;
    perspective: 1200px;
    transform: translateZ(0);

    /* Camera */
    transform: translate3d(
        calc(var(--ih-parallax-x) * -10px),
        calc(var(--ih-parallax-y) * -10px),
        0
      )
      rotateX(calc(var(--ih-parallax-y) * -7deg))
      rotateY(calc(var(--ih-parallax-x) * 10deg))
      rotateZ(calc((var(--ih-scroll) - 0.5) * -6deg))
      scale(calc(1 + (var(--ih-pinch) * 0.04) + (var(--ih-event) * 0.015)));
  }

  .ih-layer {
    position: absolute;
    inset: 0;
    transform-style: preserve-3d;
  }

  .ih-stars {
    background-image:
      radial-gradient(rgba(255, 255, 255, 0.52) 1px, transparent 1px),
      radial-gradient(rgba(255, 255, 255, 0.24) 1px, transparent 1px),
      radial-gradient(rgba(56, 189, 248, 0.15) 1px, transparent 1px);
    background-size:
      80px 80px,
      140px 140px,
      220px 220px;
    background-position:
      0 0,
      40px 60px,
      120px 20px;
    opacity: 0.42;
    transform: translateZ(-900px);
    animation: ihStars 22s linear infinite;
  }

  .ih-fog {
    opacity: 0.9;
    transform: translateZ(-320px);
    background:
      radial-gradient(
        40% 60% at 20% 30%,
        rgba(99, 102, 241, 0.22),
        transparent 70%
      ),
      radial-gradient(
        50% 60% at 70% 35%,
        rgba(56, 189, 248, 0.16),
        transparent 72%
      ),
      radial-gradient(
        65% 80% at 45% 70%,
        rgba(236, 72, 153, 0.12),
        transparent 70%
      );
    filter: blur(22px) saturate(1.2);
    animation: ihFog 12s ease-in-out infinite;
  }

  .ih-portal {
    pointer-events: none;
    opacity: 0.9;
    transform: translateZ(-120px);
  }

  .ih-portal::before,
  .ih-portal::after {
    content: '';
    position: absolute;
    inset: -20%;
    border-radius: 999px;
    background: conic-gradient(
      from 90deg,
      rgba(56, 189, 248, 0),
      rgba(99, 102, 241, 0.25),
      rgba(236, 72, 153, 0.22),
      rgba(251, 146, 60, 0.2),
      rgba(56, 189, 248, 0)
    );
    mask: radial-gradient(circle, transparent 46%, #000 55%);
    filter: blur(calc(2px + (var(--ih-pinch) * 2px)));
    transform: rotate(calc(var(--ih-scroll) * 720deg));
    animation: ihPortal 10s linear infinite;
  }

  .ih-portal::after {
    inset: -35%;
    opacity: calc(0.45 + (var(--ih-event) * 0.18));
    filter: blur(
      calc(10px + (var(--ih-burst) * 4px) + (var(--ih-event) * 8px))
    );
    transform: rotate(calc(var(--ih-scroll) * -680deg));
  }

  .ih-ribbons {
    transform: translateZ(260px);
    opacity: 0.9;
    mix-blend-mode: screen;
  }

  .ih-ribbon {
    position: absolute;
    left: calc(50% + (var(--x) * 1%));
    top: calc(50% + (var(--y) * 1%));
    width: calc(var(--w) * 1px);
    height: 140vh;
    border-radius: 999px;
    opacity: var(--a);

    background: linear-gradient(
      180deg,
      hsla(var(--h), 95%, 70%, 0),
      hsla(var(--h), 95%, 70%, 0.85),
      hsla(var(--h), 95%, 70%, 0)
    );

    transform: translate3d(-50%, -50%, calc(var(--z) * 1px))
      rotateX(calc(var(--rx) * 1deg)) rotateY(calc(var(--ry) * 1deg))
      rotateZ(calc((var(--i) * 12deg) + (var(--ih-scroll) * 220deg)))
      scaleY(calc(0.7 + (var(--ih-vel) * 0.7)));

    filter: blur(calc(0.2px + (var(--ih-vel) * 0.9px)));
    animation: ihRibbon 6.5s ease-in-out infinite;
    animation-delay: calc(var(--i) * -0.18s);
  }

  .ih-prisms {
    opacity: 0.9;
    transform: translateZ(0);
    mix-blend-mode: screen;
  }

  .ih-prism {
    position: absolute;
    left: calc(50% + (var(--x) * 1%));
    top: calc(50% + (var(--y) * 1%));
    width: calc(60px * var(--s));
    height: calc(60px * var(--s));

    clip-path: polygon(50% 0%, 92% 22%, 100% 62%, 50% 100%, 0 62%, 8% 22%);

    background:
      linear-gradient(
        135deg,
        hsla(var(--h), 95%, 65%, calc(var(--a) * 0.9)),
        rgba(255, 255, 255, 0)
      ),
      radial-gradient(
        circle at 30% 30%,
        rgba(255, 255, 255, 0.9),
        rgba(255, 255, 255, 0) 55%
      );

    border: 1px solid hsla(var(--h), 95%, 70%, calc(var(--a) * 0.8));
    box-shadow:
      0 0 30px hsla(var(--h), 95%, 70%, calc(var(--a) * 0.55)),
      0 0 90px hsla(var(--h), 95%, 70%, calc(var(--a) * 0.2));

    opacity: calc(0.15 + (var(--a) * 1));

    transform: translate3d(-50%, -50%, calc(var(--z) * 1px))
      rotateX(calc(var(--rx) * 1deg)) rotateY(calc(var(--ry) * 1deg))
      rotateZ(calc(var(--rz) * 1deg))
      scale(calc(0.85 + (var(--ih-local) * 0.35)))
      translateZ(calc(var(--ih-vel) * 70px));

    filter: blur(calc(0.1px + (var(--ih-vel) * 0.8px)));
    animation: ihPrism 9s ease-in-out infinite;
    animation-delay: calc(var(--i) * -0.22s);
  }

  .ih-shards {
    opacity: 0.65;
    transform: translateZ(0);
    mix-blend-mode: screen;
  }

  .ih-shard {
    position: absolute;
    left: calc(50% + (var(--x) * 1%));
    top: calc(50% + (var(--y) * 1%));
    width: calc(90px * var(--s));
    height: calc(42px * var(--s));

    clip-path: polygon(0% 20%, 55% 0%, 100% 30%, 75% 100%, 20% 80%);

    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, calc(var(--a) * 0.7)),
      hsla(var(--h), 95%, 70%, calc(var(--a) * 0.7)),
      rgba(255, 255, 255, 0)
    );

    opacity: calc(0.08 + (var(--a) * 1));

    transform: translate3d(-50%, -50%, calc(var(--z) * 1px))
      rotateX(calc(var(--rx) * 1deg)) rotateY(calc(var(--ry) * 1deg))
      rotateZ(calc(var(--rz) * 1deg))
      translateY(calc((var(--ih-scroll) - 0.5) * -90px))
      translateZ(calc(var(--ih-vel) * 120px));

    filter: blur(calc(0.2px + (var(--ih-vel) * 1px)));
    animation: ihShard 7s ease-in-out infinite;
    animation-delay: calc(var(--i) * -0.2s);
  }

  .ih-track {
    position: relative;
    z-index: 1;
  }

  .ih-chapter {
    min-height: 110vh;
  }

  @keyframes ihStars {
    to {
      background-position:
        180px 220px,
        -120px 240px,
        320px -160px;
    }
  }

  @keyframes ihFog {
    0%,
    100% {
      transform: translateZ(-320px) translateY(0);
      opacity: 0.85;
    }
    50% {
      transform: translateZ(-320px) translateY(-18px);
      opacity: 1;
    }
  }

  @keyframes ihPortal {
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes ihRibbon {
    0%,
    100% {
      opacity: calc(var(--a) * 0.7);
    }
    50% {
      opacity: calc(var(--a) * 1);
    }
  }

  @keyframes ihPrism {
    0%,
    100% {
      transform: translate3d(-50%, -50%, calc(var(--z) * 1px))
        rotateX(calc(var(--rx) * 1deg)) rotateY(calc(var(--ry) * 1deg))
        rotateZ(calc(var(--rz) * 1deg));
      opacity: calc(0.12 + (var(--a) * 0.85));
    }
    50% {
      transform: translate3d(
          -50%,
          -50%,
          calc((var(--z) * 1px) + (var(--ih-vel) * 140px))
        )
        rotateX(calc((var(--rx) + 40) * 1deg))
        rotateY(calc((var(--ry) - 60) * 1deg))
        rotateZ(calc((var(--rz) + 30) * 1deg))
        scale(calc(1 + (var(--ih-local) * 0.6)));
      opacity: calc(0.18 + (var(--a) * 1));
    }
  }

  @keyframes ihShard {
    0%,
    100% {
      opacity: calc(0.08 + (var(--a) * 0.55));
    }
    50% {
      opacity: calc(0.14 + (var(--a) * 1));
    }
  }

  @media (max-width: 820px) {
    .ih-prism {
      width: calc(52px * var(--s));
      height: calc(52px * var(--s));
    }

    .ih-ribbon {
      height: 120vh;
    }
  }

  @media (pointer: coarse) {
    .ih-ribbons {
      opacity: 0.65;
    }

    .ih-shards {
      display: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .ih * {
      animation: none !important;
      transition: none !important;
    }

    .ih-canvas {
      display: none;
    }

    .ih-ribbons,
    .ih-shards {
      display: none;
    }

    .ih-prism {
      filter: none;
    }
  }
</style>

<script>
  // New immersive controller (scroll morphs + physics particles)
  import '../../scripts/immersive-home';
</script>
