---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import ModernCard from '../components/ui/ModernCard.astro';
import ModernButton from '../components/ui/ModernButton.astro';
import { withBasePath } from '../utils/helpers';

const title = 'You are offline';
const description = 'This page is available offline thanks to service workers';
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <BaseHead title={title} description={description} />
  </head>
  <body class="flex min-h-screen flex-col bg-zinc-950 text-zinc-100">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-[100] focus:rounded-sm focus:bg-accent-600 focus:px-4 focus:py-2 focus:text-white focus:outline-none focus:ring-2 focus:ring-accent-400"
    >
      Skip to main content
    </a>
    <Header />
    <main
      id="main-content"
      tabindex="-1"
      class="relative flex flex-1 items-center overflow-hidden px-4"
    >
      <div
        class="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"
      >
      </div>
      <div class="relative z-10 mx-auto w-full max-w-2xl text-center">
        <div class="mb-8">
          <ModernCard
            variant="minimal"
            className="relative inline-flex h-32 w-32 items-center justify-center rounded-full"
          >
            <div
              class="absolute inset-0 animate-pulse rounded-full border border-zinc-700 opacity-50"
            >
            </div>
            <svg
              class="h-16 w-16 text-zinc-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"
              ></path>
            </svg>
          </ModernCard>
        </div>

        <h1
          class="mb-4 font-display text-4xl font-bold uppercase tracking-tight text-white"
        >
          OFFLINE_MODE
        </h1>
        <p class="mb-8 font-mono text-xl text-zinc-400">
          // Don't worry! Thanks to our service worker, you can still browse
          cached pages.
        </p>

        <div class="mb-12 space-y-4">
          <ModernCard variant="minimal" className="relative p-6 text-left">
            <div
              class="absolute left-0 top-0 h-2 w-2 border-l border-t border-zinc-700"
            >
            </div>
            <div
              class="absolute right-0 top-0 h-2 w-2 border-r border-t border-zinc-700"
            >
            </div>
            <div
              class="absolute bottom-0 left-0 h-2 w-2 border-b border-l border-zinc-700"
            >
            </div>
            <div
              class="absolute bottom-0 right-0 h-2 w-2 border-b border-r border-zinc-700"
            >
            </div>

            <h2
              class="mb-2 font-mono text-lg font-bold uppercase tracking-wider text-white"
            >
              AVAILABLE_ACTIONS:
            </h2>
            <ul class="space-y-2 font-mono text-sm text-zinc-300">
              <li class="flex items-start gap-2">
                <svg
                  class="mt-0.5 h-5 w-5 flex-shrink-0 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Browse previously visited pages</span>
              </li>
              <li class="flex items-start gap-2">
                <svg
                  class="mt-0.5 h-5 w-5 flex-shrink-0 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Review cached pages and resources</span>
              </li>
              <li class="flex items-start gap-2">
                <svg
                  class="mt-0.5 h-5 w-5 flex-shrink-0 text-blue-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Check connection status below</span>
              </li>
            </ul>
          </ModernCard>

          <div
            id="connection-status"
            class="rounded-xl border border-amber-800/30 bg-amber-900/20 p-4"
          >
            <p class="font-medium text-amber-200">
              <span id="status-icon">⚠️</span>
              <span id="status-text">Checking connection...</span>
            </p>
          </div>
        </div>

        <div class="flex flex-wrap justify-center gap-4">
          <ModernButton id="retry-button" variant="primary">
            Try Again
          </ModernButton>
          <ModernButton href={withBasePath('/')} variant="secondary">
            Go to Homepage
          </ModernButton>
        </div>
      </div>
    </main>

    <script>
      // VS Code Simple Browser / local preview can get stuck on this page if an old
      // service worker keeps serving the offline fallback. On localhost, auto-clean.
      (async () => {
        try {
          const isLocalHost =
            location.hostname === 'localhost' ||
            location.hostname === '127.0.0.1' ||
            location.hostname === '[::1]';

          if (!isLocalHost) return;

          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }

          if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(
              keys
                .filter(k => k.startsWith('github-pages-project-'))
                .map(k => caches.delete(k))
            );
          }

          // After cleanup, bounce back to the homepage.
          // Respect base paths like /dontforgetyourtowel/ used in local preview.
          const parts = location.pathname.split('/').filter(Boolean);
          const base =
            parts.length === 0 || parts[0] === 'offline'
              ? '/'
              : `/${parts[0]}/`;
          location.replace(base);
        } catch {
          // ignore
        }
      })();

      // Check connection status
      function updateConnectionStatus() {
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const statusDiv = document.getElementById('connection-status');

        if (navigator.onLine) {
          if (statusIcon && statusText && statusDiv) {
            statusIcon.textContent = '✅';
            statusText.textContent =
              'Connection restored! You can reload the page.';
            statusDiv.className =
              'p-4 bg-green-900/20 border border-green-800/30 rounded-xl';
          }
        } else {
          if (statusIcon && statusText && statusDiv) {
            statusIcon.textContent = '⚠️';
            statusText.textContent =
              'Still offline. Please check your connection.';
            statusDiv.className =
              'p-4 bg-amber-900/20 border border-amber-800/30 rounded-xl';
          }
        }
      }

      // Initial check
      updateConnectionStatus();

      // Listen for connection changes
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);

      // Retry button
      const retryButton = document.getElementById('retry-button');
      retryButton?.addEventListener('click', () => {
        if (navigator.onLine) {
          window.location.reload();
        } else {
          alert('Still offline. Please check your connection and try again.');
        }
      });

      // Auto-reload when connection restored
      window.addEventListener('online', () => {
        setTimeout(() => {
          if (confirm('Connection restored! Reload page?')) {
            window.location.reload();
          }
        }, 1000);
      });
    </script>
  </body>
</html>
