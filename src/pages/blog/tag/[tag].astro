---
import { getCollection } from 'astro:content';
import MarketingLayout from '../../../layouts/MarketingLayout.astro';
import ModernCard from '../../../components/ui/ModernCard.astro';
import { withBasePath } from '../../../utils/helpers';

export const prerender = true;

export async function getStaticPaths() {
  const posts = (await getCollection('blog' as never)) as any[];
  const published = posts.filter(entry => !entry.data.draft);

  const tags = new Set<string>();
  published.forEach(entry => {
    (entry.data.tags || []).forEach((t: string) => tags.add(t));
  });

  return Array.from(tags).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;
const posts = (await getCollection('blog' as never)) as any[];
const published = posts
  .filter(entry => !entry.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const tagged = published.filter(entry => (entry.data.tags || []).includes(tag));
---

<MarketingLayout
  title={`Tag: ${tag}`}
  description={`Posts tagged with “${tag}”.`}
  mainClass="pb-20 pt-10"
>
  <section class="mx-auto max-w-[1100px] px-6">
    <header class="space-y-2">
      <p class="font-mono text-xs uppercase tracking-widest text-zinc-400">
        Blog tag
      </p>
      <h1 class="font-display text-3xl font-semibold text-white sm:text-4xl">
        {tag}
      </h1>
      <p class="text-sm text-zinc-300">{tagged.length} post(s)</p>
      <p class="text-sm">
        <a class="text-accent-400 hover:underline" href={withBasePath('blog/')}
          >Back to blog</a
        >
      </p>
    </header>

    <div class="mt-10 grid gap-5 sm:grid-cols-2">
      {
        tagged.map((entry: any) => (
          <ModernCard variant="glass" className="p-5">
            <h2 class="text-lg font-semibold text-white">
              <a
                class="hover:underline"
                href={withBasePath(`blog/${entry.id}/`)}
              >
                {entry.data.title}
              </a>
            </h2>
            <p class="mt-2 text-sm leading-relaxed text-zinc-300">
              {entry.data.description}
            </p>
          </ModernCard>
        ))
      }
    </div>
  </section>
</MarketingLayout>
